<div widget class="card border-0 box-shadow">
  <div class="card-header transparent border-0 text-muted">
    <h5 class="mb-0">
      <i class="fa fa-chart-line"></i> Profit & Loss Statement
      <span *ngIf="bdata && bdata.length > 0" 
            class="badge badge-pill ml-2"
            [ngClass]="profitLossSummary.netProfit >= 0 ? 'badge-success' : 'badge-danger'">
        {{ profitLossSummary.netProfit >= 0 ? 'PROFIT' : 'LOSS' }}
      </span>
    </h5>
  </div>
  <div class="card-block widget-body">
    <form #frmFilter="ngForm">
      <div class="row">
        <div class="col-md-2">
          <label for="dtFrom">From Date:</label>
          <div class="input-group">
            <input
              class="form-control"
              placeholder="yyyy-mm-dd"
              name="dtFrom"
              [(ngModel)]="Filter.FromDate"
              ngbDatepicker
              #dtFrom="ngbDatepicker"
            />
            <div class="input-group-addon">
              <button
                type="button"
                class="btn btn-warning"
                (click)="dtFrom.toggle()"
              >
                <i class="fa fa-calendar"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <label for="dtTo">To Date:</label>
          <div class="input-group">
            <input
              class="form-control"
              placeholder="yyyy-mm-dd"
              name="dtTo"
              [(ngModel)]="Filter.ToDate"
              ngbDatepicker
              #dtTo="ngbDatepicker"
            />
            <div class="input-group-addon">
              <button
                type="button"
                class="btn btn-warning"
                (click)="dtTo.toggle()"
              >
                <i class="fa fa-calendar"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="col-md-2">
          <div class="form-group">
            <label>&nbsp;</label>
            <button
              type="submit"
              class="btn btn-primary form-control"
              (click)="FilterData()"
              accesskey="a"
            >
              <i class="fa fa-search"></i>
              Filter
            </button>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label>&nbsp;</label>
            <button
              type="button"
              class="btn btn-info form-control"
              (click)="PrintReport()"
              accesskey="P"
            >
              <i class="fa fa-print"></i>
              Print
            </button>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label>&nbsp;</label>
            <button
              type="button"
              class="btn btn-success form-control"
              (click)="calculateProfitLossSummary(bdata)"
              title="Recalculate P&L Summary"
              [disabled]="!bdata || bdata.length === 0"
            >
              <i class="fa fa-calculator"></i>
              Calculate
            </button>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label>&nbsp;</label>
            <button
              type="button"
              class="btn btn-warning form-control"
              (click)="testWithSampleData()"
              title="Test with sample P&L data"
            >
              <i class="fa fa-flask"></i>
              Test
            </button>
          </div>
        </div>
      </div>
    </form>

    <!-- Profit & Loss Summary Cards -->
    <div class="row mb-4" *ngIf="bdata && bdata.length > 0">
      <div class="col-md-2">
        <div class="card bg-light border-primary">
          <div class="card-body text-center p-2">
            <h6 class="card-title text-primary mb-1">
              <i class="fa fa-money-bill-wave"></i> Revenue
            </h6>
            <h5 class="text-primary mb-0">{{ formatCurrency(profitLossSummary.totalRevenue) }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card bg-light border-warning">
          <div class="card-body text-center p-2">
            <h6 class="card-title text-warning mb-1">
              <i class="fa fa-shopping-cart"></i> COGS
            </h6>
            <h5 class="text-warning mb-0">{{ formatCurrency(profitLossSummary.totalCostOfGoodsSold) }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card bg-light border-info">
          <div class="card-body text-center p-2">
            <h6 class="card-title text-info mb-1">
              <i class="fa fa-chart-bar"></i> Gross Profit
            </h6>
            <h5 class="text-info mb-0">{{ formatCurrency(profitLossSummary.grossProfit) }}</h5>
            <small class="text-muted">{{ formatCurrency(profitLossSummary.grossProfitMargin) }}%</small>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card bg-light border-secondary">
          <div class="card-body text-center p-2">
            <h6 class="card-title text-secondary mb-1">
              <i class="fa fa-receipt"></i> Expenses
            </h6>
            <h5 class="text-secondary mb-0">{{ formatCurrency(profitLossSummary.totalExpenses) }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card bg-light" 
             [ngClass]="profitLossSummary.netProfit >= 0 ? 'border-success' : 'border-danger'">
          <div class="card-body text-center p-2">
            <h6 class="card-title mb-1" [ngClass]="getProfitStatusClass()">
              <i class="fa" [ngClass]="getProfitStatusIcon()"></i> Net Profit
            </h6>
            <h5 class="mb-0" [ngClass]="getProfitStatusClass()">
              {{ formatCurrency(getAbsoluteValue(profitLossSummary.netProfit)) }}
            </h5>
            <small class="text-muted">{{ formatCurrency(profitLossSummary.netProfitMargin) }}%</small>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card bg-light" 
             [ngClass]="profitLossSummary.netProfit >= 0 ? 'border-success' : 'border-danger'">
          <div class="card-body text-center p-2">
            <h6 class="card-title mb-1" [ngClass]="getProfitStatusClass()">
              <i class="fa fa-flag"></i> Status
            </h6>
            <h6 class="mb-0" [ngClass]="getProfitStatusClass()">
              {{ profitLossSummary.netProfit >= 0 ? 'PROFIT' : 'LOSS' }}
            </h6>
          </div>
        </div>
      </div>
    </div>
    <div class="row" id="print-section">
      <div class="col-md-12">
        <table class="table table-light">
          <thead>
            <tr class="table-dark">
              <th style="width: 60%">Particulars</th>
              <th style="width: 20%" class="text-right">Amount</th>
              <th style="width: 20%" class="text-right">Total</th>
            </tr>
          </thead>
          <tbody>
            <!-- REVENUE SECTION -->
            <tr class="table-primary">
              <td colspan="3">
                <h5 class="mb-0 text-primary">
                  <i class="fa fa-money-bill-wave"></i> REVENUE
                </h5>
              </td>
            </tr>
            <ng-container *ngIf="data['Revenue accounts']">
              <ng-container *ngFor="let level2 of GetProps(GetGroupBy(data['Revenue accounts'], 'Level2'))">
                <tr>
                  <td style="padding-left: 20px;">
                    <strong class="text-info">{{ level2 }}</strong>
                  </td>
                  <td class="text-right">
                    <span class="text-info">
                      {{ formatCurrency(calculateNetAmount(GetGroupBy(data['Revenue accounts'], 'Level2')[level2], true)) }}
                    </span>
                  </td>
                  <td></td>
                </tr>
                <!-- Individual accounts under this level2 -->
                <tr *ngFor="let account of GetGroupBy(data['Revenue accounts'], 'Level2')[level2]">
                  <td style="padding-left: 40px;" class="small">
                    {{ account.AccountName }}
                  </td>
                  <td class="text-right small">
                    {{ formatCurrency(parseFloat(account.Credit || 0) - parseFloat(account.Debit || 0)) }}
                  </td>
                  <td></td>
                </tr>
              </ng-container>
              <tr class="table-secondary">
                <td class="thick-border">
                  <strong>Total Revenue</strong>
                </td>
                <td></td>
                <td class="thick-border text-right">
                  <h6 class="text-primary mb-0">
                    <strong>{{ formatCurrency(profitLossSummary.totalRevenue) }}</strong>
                  </h6>
                </td>
              </tr>
            </ng-container>

            <!-- COST OF GOODS SOLD SECTION -->
            <tr class="table-warning">
              <td colspan="3">
                <h5 class="mb-0 text-warning">
                  <i class="fa fa-shopping-cart"></i> COST OF GOODS SOLD
                </h5>
              </td>
            </tr>
            <ng-container *ngIf="data['Cost of goods sold']">
              <ng-container *ngFor="let level2 of GetProps(GetGroupBy(data['Cost of goods sold'], 'Level2'))">
                <tr>
                  <td style="padding-left: 20px;">
                    <strong class="text-warning">{{ level2 }}</strong>
                  </td>
                  <td class="text-right">
                    <span class="text-warning">
                      {{ formatCurrency(calculateNetAmount(GetGroupBy(data['Cost of goods sold'], 'Level2')[level2], false)) }}
                    </span>
                  </td>
                  <td></td>
                </tr>
                <!-- Individual accounts under this level2 -->
                <tr *ngFor="let account of GetGroupBy(data['Cost of goods sold'], 'Level2')[level2]">
                  <td style="padding-left: 40px;" class="small">
                    {{ account.AccountName }}
                  </td>
                  <td class="text-right small">
                    {{ formatCurrency(parseFloat(account.Debit || 0) - parseFloat(account.Credit || 0)) }}
                  </td>
                  <td></td>
                </tr>
              </ng-container>
              <tr class="table-secondary">
                <td class="thick-border">
                  <strong>Total Cost of Goods Sold</strong>
                </td>
                <td></td>
                <td class="thick-border text-right">
                  <h6 class="text-warning mb-0">
                    <strong>{{ formatCurrency(profitLossSummary.totalCostOfGoodsSold) }}</strong>
                  </h6>
                </td>
              </tr>
            </ng-container>

            <!-- GROSS PROFIT -->
            <tr class="table-info">
              <td class="thick-border">
                <h6 class="mb-0">
                  <strong>GROSS PROFIT</strong>
                  <small class="text-muted">(Revenue - COGS)</small>
                </h6>
              </td>
              <td></td>
              <td class="thick-border text-right">
                <h5 class="mb-0" [ngClass]="getAmountClass(profitLossSummary.grossProfit)">
                  <strong>{{ formatCurrency(getAbsoluteValue(profitLossSummary.grossProfit)) }}</strong>
                </h5>
              </td>
            </tr>

            <!-- OPERATING EXPENSES SECTION -->
            <tr class="table-secondary">
              <td colspan="3">
                <h5 class="mb-0 text-secondary">
                  <i class="fa fa-receipt"></i> OPERATING EXPENSES
                </h5>
              </td>
            </tr>
            <ng-container *ngIf="data['Expense accounts']">
              <ng-container *ngFor="let level2 of GetProps(GetGroupBy(data['Expense accounts'], 'Level2'))">
                <tr>
                  <td style="padding-left: 20px;">
                    <strong class="text-secondary">{{ level2 }}</strong>
                  </td>
                  <td class="text-right">
                    <span class="text-secondary">
                      {{ formatCurrency(calculateNetAmount(GetGroupBy(data['Expense accounts'], 'Level2')[level2], false)) }}
                    </span>
                  </td>
                  <td></td>
                </tr>
                <!-- Individual accounts under this level2 -->
                <tr *ngFor="let account of GetGroupBy(data['Expense accounts'], 'Level2')[level2]">
                  <td style="padding-left: 40px;" class="small">
                    {{ account.AccountName }}
                  </td>
                  <td class="text-right small">
                    {{ formatCurrency(parseFloat(account.Debit || 0) - parseFloat(account.Credit || 0)) }}
                  </td>
                  <td></td>
                </tr>
              </ng-container>
              <tr class="table-secondary">
                <td class="thick-border">
                  <strong>Total Operating Expenses</strong>
                </td>
                <td></td>
                <td class="thick-border text-right">
                  <h6 class="text-secondary mb-0">
                    <strong>{{ formatCurrency(profitLossSummary.totalExpenses) }}</strong>
                  </h6>
                </td>
              </tr>
            </ng-container>

            <!-- NET PROFIT/LOSS -->
            <tr class="table-dark">
              <td class="thick-border">
                <h5 class="mb-0 text-white">
                  <i class="fa" [ngClass]="getProfitStatusIcon()"></i>
                  NET {{ profitLossSummary.netProfit >= 0 ? 'PROFIT' : 'LOSS' }}
                  <small class="text-light">(Gross Profit - Expenses)</small>
                </h5>
              </td>
              <td></td>
              <td class="thick-border text-right">
                <h4 class="mb-0" [ngClass]="getProfitStatusClass()">
                  <strong>{{ formatCurrency(getAbsoluteValue(profitLossSummary.netProfit)) }}</strong>
                </h4>
                <small class="text-light">
                  Margin: {{ formatCurrency(profitLossSummary.netProfitMargin) }}%
                </small>
              </td>
            </tr>

            <!-- NET RESULT (if exists in data) -->
            <ng-container *ngIf="data['Net Result']">
              <tr class="table-light">
                <td colspan="3">
                  <h6 class="mb-0 text-muted">
                    <i class="fa fa-info-circle"></i> NET RESULT (From System)
                  </h6>
                </td>
              </tr>
              <tr *ngFor="let account of data['Net Result']">
                <td style="padding-left: 20px;">
                  <strong>{{ account.AccountName }}</strong>
                </td>
                <td class="text-right">
                  {{ formatCurrency(parseFloat(account.Credit || 0) - parseFloat(account.Debit || 0)) }}
                </td>
                <td></td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
