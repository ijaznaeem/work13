# Virtual Hosts Configuration
# PHP Multi-Version Setup

# Main site - Default PHP 8.4
<VirtualHost *:8080>
    ServerName localhost
    DocumentRoot "/opt/homebrew/var/www"
    DirectoryIndex index.php index.html

    <Directory "/opt/homebrew/var/www">
        AllowOverride All
        Require all granted
    </Directory>

    # PHP 8.4 via PHP-FPM
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://127.0.0.1:9000"
    </FilesMatch>

    ErrorLog "/opt/homebrew/var/log/httpd/localhost_error.log"
    CustomLog "/opt/homebrew/var/log/httpd/localhost_access.log" common
</VirtualHost>

# PHP 7.4 Sites
<VirtualHost *:8080>
    ServerName php74.localhost
    DocumentRoot "/opt/homebrew/var/www/php74"
    DirectoryIndex index.php index.html

    <Directory "/opt/homebrew/var/www/php74">
        AllowOverride All
        Require all granted
        Options +FollowSymLinks
    </Directory>

    # ePOSPlus APIs directory configuration via symbolic link
    <Directory "/opt/homebrew/var/www/php74/posplus">
        AllowOverride All
        Require all granted
        Options +FollowSymLinks -Indexes
        DirectoryIndex index.php

        # Enable rewrite engine for CodeIgniter
        RewriteEngine On
        RewriteBase /posplus/

        # CodeIgniter specific rules
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond $1 !^(index\.php|assets|install|update)
        RewriteRule ^(.*)$ index.php/$1 [NC,L,QSA]
    </Directory>

    # Security: Prevent access to system and application folders
    <Directory "/opt/homebrew/var/www/php74/posplus/system">
        Require all denied
    </Directory>

    <Directory "/opt/homebrew/var/www/php74/posplus/application">
        Require all denied
    </Directory>

    # Allow access to application assets if they exist
    <Directory "/opt/homebrew/var/www/php74/posplus/assets">
        AllowOverride None
        Require all granted
    </Directory>

    # PHP 7.4 via PHP-FPM
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://127.0.0.1:9074"
    </FilesMatch>

    ErrorLog "/opt/homebrew/var/log/httpd/php74_error.log"
    CustomLog "/opt/homebrew/var/log/httpd/php74_access.log" common
</VirtualHost>

# PHP 8.4 Sites (Alternative domain)
<VirtualHost *:8080>
    ServerName php84.localhost
    DocumentRoot "/opt/homebrew/var/www/php84"
    DirectoryIndex index.php index.html

    <Directory "/opt/homebrew/var/www/php84">
        AllowOverride All
        Require all granted
    </Directory>

    # PHP 8.4 via PHP-FPM
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://127.0.0.1:9000"
    </FilesMatch>

    ErrorLog "/opt/homebrew/var/log/httpd/php84_error.log"
    CustomLog "/opt/homebrew/var/log/httpd/php84_access.log" common
</VirtualHost>
