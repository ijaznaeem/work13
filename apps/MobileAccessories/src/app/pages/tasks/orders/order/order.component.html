<!--table starts-->
<section id="ng-tables">
  <div class="card">
    <div class="card-content">
      <div class="card-body">
        <form (ngSubmit)="SaveData()" #fromPurchase="ngForm">
          <div class="row">
            <div class="col-md-4">
              <label for="customer">Filter by Category</label>
              <ng-select
                [items]="Categories"
                name="cmbCategory"
                id="cmbCategory"
                [virtualScroll]="true"
                bindLabel="CategoryName"
                bindValue="CategoryID"
                placeholder="All Categories"
                (change)="categorySelected($event)"
                [clearable]="true"
              >
                <!-- Custom option template -->
                <ng-template ng-option-tmp let-item="item">
                  <div class="option-wrapper">
                    <img
                      class="product-thumb"
                      [src]="UploadFolder + item.ImageUrl"
                      alt="{{ item.CategoryName }}"
                      style="
                        width: 30px;
                        height: 30px;
                        object-fit: cover;
                        border-radius: 4px;
                      "
                    />
                    <span class="ml-2">{{ item.CategoryName }}</span>
                  </div>
                </ng-template>

                <!-- Custom selected value template -->
                <ng-template ng-label-tmp let-item="item">
                  <div class="selected-wrapper">
                    <img
                      class="product-thumb"
                      [src]="UploadFolder + item.ImageUrl"
                      alt="{{ item.CategoryName }}"
                      style="
                        width: 20px;
                        height: 20px;
                        object-fit: cover;
                        border-radius: 4px;
                      "
                    />
                    <span class="ml-2">{{ item.CategoryName }}</span>
                  </div>
                </ng-template>
              </ng-select>
            </div>

            <div class="col-md-6 col-sm-12">
              <label>Search Products</label>
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Type to search products by name, description..."
                  [(ngModel)]="searchTerm"
                  (input)="onSearchProducts()"
                  name="searchTerm"
                  (keydown.enter)="$event.preventDefault(); focusFirstProduct()"
                />
                <div class="input-group-append">
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    (click)="clearSearch()"
                    title="Clear search"
                  >
                    <i class="fa fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Enhanced Product Grid View -->
          <div
            *ngIf="viewMode === 'grid' && FilteredProducts.length > 0"
            class="row"
          >
            <div class="col-12">
              <div
                class="product-grid"
                style="height: calc(100vh - 250px); overflow-y: auto"
              >
                <div class="row">
                  <div
                    class="col-md-4 col-xs-12 col-sm-12 mb-3"
                    *ngFor="let product of FilteredProducts; let i = index"
                  >
                    <div class="card product-card h-100" [id]="'product-' + i">
                      <img
                        [src]="product.Image"
                        class="card-img-top"
                        (click)="ShowPicture(product)"
                        [class.selected]="isProductSelected(product)"
                        [class.bulk-selected]="isBulkSelected(product)"
                        style="cursor: hand; transition: all 0.3s"
                        [alt]="product.ProductName"
                        style="height: 200px; object-fit: cover"
                      />
                      <div class="card-body p-2 d-flex flex-column">
                        <h6
                          class="card-title text-truncate flex-grow-1"
                          style="color: black"
                          [title]="product.ProductName"
                        >
                          {{ product.ProductName }}
                        </h6>
                        <div
                          class="d-flex justify-content-between align-items-center mt-auto"
                        >
                          <span class="badge badge-primary"
                            >€{{ product.SPrice | number: '1.2-2' }}</span
                          >
                          <button
                            class="btn btn-danger"
                            type="button"
                            (click)="addToCart(product)"
                          >
                            <i class="fa fa-plus"></i>Add to Cart
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <!-- Order Items Summary -->
                  <div class="alert alert-success mt-3">
                    <div class="row align-items-center">
                      <div class="col-md-4 col-12 mb-2 mb-md-0">
                        <h6 class="mb-0">
                          <i class="fa fa-shopping-cart"></i> Order Items
                          <span class="badge badge-light text-primary ml-2">{{
                            orderItemsCount
                          }}</span>
                        </h6>
                      </div>

                      <div class="col-md-4 col-12 text-md-right">
                        <button
                          type="submit"
                          class="btn btn-warning btn-sm mr-2"
                          *ngIf="EditID != 0 && order.CustomerID != 0"
                          [disabled]="orderItemsCount === 0"
                        >
                          <i class="fa fa-save"></i>
                          Save Order
                        </button>
                        <button
                          type="button"
                          class="btn btn-danger btn-sm"
                          (click)="showOrderDetails()"
                          [disabled]="orderItemsCount === 0"
                        >
                          <i class="fa fa-list"></i> Check Out
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Order Details Modal -->
          <div
            class="modal fade show"
            [style.display]="showOrderDetailsModal ? 'block' : 'none'"
            *ngIf="showOrderDetailsModal"
            tabindex="-1"
            role="dialog"
            style="background-color: rgba(0, 0, 0, 0.5)"
          >
            <div class="modal-dialog modal-xl" role="document">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title">
                    <i class="fa fa-shopping-cart"></i> Order Details
                    <span class="badge badge-light text-primary ml-2"
                      >{{ orderItemsCount }} items</span
                    >
                  </h5>
                  <button
                    type="button"
                    class="btn btn-link text-white"
                    (click)="closeOrderDetails()"
                    title="Close"
                  >
                    <i class="fa fa-times fa-lg"></i>
                  </button>
                </div>
                <div class="modal-body">
                  <div *ngIf="orderItemsCount === 0" class="text-center py-4">
                    <i class="fa fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No items in order</h5>
                    <p class="text-muted">Add products to see them here</p>
                  </div>
                  <div class="row no-gutter">
                    <div class="col-md-2">
                      <label for="dp1">Date:</label>
                      <div class="input-group">
                        <input
                          class="form-control"
                          placeholder="yyyy-mm-dd"
                          name="dp1"
                          [(ngModel)]="order.Date"
                          ngbDatepicker
                          #d1="ngbDatepicker"
                          required
                        />
                        <div class="input-group-addon">
                          <button
                            type="button"
                            class="btn btn-warning"
                            (click)="d1.toggle()"
                          >
                            <i class="fa fa-calendar"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <div class="form-group col-md-6">
                      <label for="customer">Customer </label>
                      <ng-select
                        #cmbCustomers
                        name="customer"
                        class="custom"
                        [items]="Accounts"
                        [virtualScroll]="true"
                        bindLabel="CustomerName"
                        bindValue="CustomerID"
                        placeholder="Select Customer"
                        required
                        [(ngModel)]="order.CustomerID"
                        selectOnTab="true"
                      >
                        <ng-template ng-option-tmp let-item="item">
                          <div class="row no-gutter">
                            <div class="col-md-12">
                              <strong>{{ item.CustomerName }}</strong>
                            </div>
                            <div
                              class="col-md-12 text-italic font-small-2 mt-1"
                            >
                              <small>
                                {{ item.Address }}, {{ item.City }}
                              </small>
                            </div>
                          </div>
                        </ng-template>
                      </ng-select>
                    </div>
                    <div class="col-md-2">
                      <div class="form-group">
                        <label for="gtotal">Total Order Amount</label>
                        <input
                          type="text"
                          class="form-control bold-input bg-light"
                          id="gtotal"
                          name="gtotal"
                          [value]="
                            order.Amount | currency: 'EUR':'symbol':'1.2-2'
                          "
                          readonly
                          style="font-weight: bold; font-size: 1.1rem"
                        />
                      </div>
                    </div>
                  </div>
                  <div *ngIf="orderItemsCount > 0">
                    <div class="table-responsive">
                      <table class="table table-bordered order-details-table">
                        <thead class="thead-dark">
                          <tr>
                            <th width="40%">Product Information</th>
                            <th width="25%">Price & Qty</th>
                            <th width="20%">Amount</th>
                            <th width="15%">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <ng-container
                            *ngFor="let item of orderItems; let i = index"
                          >
                            <!-- First Row: Product Name -->
                            <tr class="table-light">
                              <td colspan="4" class="py-2">
                                <div
                                  class="d-flex justify-content-between align-items-center"
                                >
                                  <div>
                                    <h6 class="mb-0 text-primary">
                                      <i class="fa fa-cube mr-2"></i>
                                      {{ item.ProductName }}
                                    </h6>
                                    <small
                                      class="text-muted"
                                      *ngIf="item.Notes && item.Notes !== 'N/A'"
                                    >
                                      <i class="fa fa-comment mr-1"></i>
                                      {{ item.Notes }}
                                    </small>
                                  </div>
                                  <small class="text-muted"
                                    >Item #{{ i + 1 }}</small
                                  >
                                </div>
                              </td>
                            </tr>

                            <!-- Second Row: Details -->
                            <tr class="border-top-0">
                              <td class="py-2">
                                <div>
                                  <div
                                    class="mb-1"
                                    *ngIf="item.Color && item.Color !== 'N/A'"
                                  >
                                    <small class="text-muted">Color:</small>
                                    <span class="badge badge-secondary ml-1">{{
                                      item.Color
                                    }}</span>
                                  </div>
                                  <div *ngIf="item.Size && item.Size !== 'N/A'">
                                    <small class="text-muted">Size:</small>
                                    <span class="badge badge-info ml-1">{{
                                      item.Size
                                    }}</span>
                                  </div>
                                  <div
                                    *ngIf="
                                      (!item.Color || item.Color === 'N/A') &&
                                      (!item.Size || item.Size === 'N/A')
                                    "
                                  >
                                    <span class="text-muted">-</span>
                                  </div>
                                </div>
                                <div class="mb-1 text-right">
                                  <small class="text-muted">Unit Price:</small>
                                  <span>
                                    <strong class="d-block">
                                      €{{
                                        item.SPrice | number: '1.2-2'
                                      }}</strong
                                    >
                                  </span>
                                </div>
                              </td>

                              <td class="py-2">
                                <div>
                                  <small class="text-muted d-block mb-1"
                                    >Quantity:</small
                                  >
                                  <div
                                    class="input-group input-group-sm"
                                    style="max-width: 120px"
                                  >
                                    <div class="input-group-prepend">
                                      <button
                                        class="btn btn-outline-secondary btn-sm"
                                        type="button"
                                        (click)="
                                          updateOrderItemQty(item, item.Qty - 1)
                                        "
                                        [disabled]="item.Qty <= 1"
                                      >
                                        <i class="fa fa-minus"></i>
                                      </button>
                                    </div>
                                    <input
                                      type="number"
                                      name="qty{{ i }}"
                                      class="form-control form-control-sm text-center"
                                      [(ngModel)]="item.Qty"
                                      (change)="
                                        updateOrderItemQty(item, item.Qty)
                                      "
                                      min="1"
                                      style="max-width: 50px"
                                    />
                                    <div class="input-group-append">
                                      <button
                                        class="btn btn-outline-secondary btn-sm"
                                        type="button"
                                        (click)="
                                          updateOrderItemQty(item, item.Qty + 1)
                                        "
                                      >
                                        <i class="fa fa-plus"></i>
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </td>
                              <td class="py-2">
                                <small class="text-muted d-block">Total:</small>
                                <h5 class="mb-0 text-success">
                                  €{{ item.Amount | number: '1.2-2' }}
                                </h5>
                              </td>
                              <td class="py-2">
                                <div
                                  class="btn-group-vertical btn-group-sm w-100"
                                >
                                  <button
                                    class="btn btn-outline-primary btn-sm mb-1"
                                    (click)="editOrderItem(item)"
                                    title="Edit item"
                                  >
                                    <i class="fa fa-edit mr-1"></i> Edit
                                  </button>
                                  <button
                                    class="btn btn-outline-danger btn-sm"
                                    (click)="removeOrderItem(item)"
                                    title="Remove item"
                                  >
                                    <i class="fa fa-trash mr-1"></i> Remove
                                  </button>
                                </div>
                              </td>
                            </tr>

                            <!-- Separator row between items -->
                            <tr
                              *ngIf="i < orderItems.length - 1"
                              class="table-separator"
                            >
                              <td
                                colspan="4"
                                class="p-0"
                                style="
                                  height: 8px;
                                  background-color: #f8f9fa;
                                  border: none;
                                "
                              ></td>
                            </tr>
                          </ng-container>
                        </tbody>
                        <tfoot class="thead-light">
                          <tr>
                            <td colspan="2" class="text-right py-3">
                              <strong>Total Amount:</strong>
                            </td>
                            <td class="py-3">
                              <h5 class="mb-0 text-success">
                                {{
                                  order.Amount
                                    | currency: 'EUR':'symbol-narrow':'1.2-2'
                                }}
                              </h5>
                            </td>
                            <td class="py-3"></td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="submit"
                    class="btn btn-success"
                    [disabled]="!fromPurchase.form.valid"
                  >
                    <i class="fa fa-save"></i> Save
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    (click)="closeOrderDetails()"
                  >
                    <i class="fa fa-times"></i> Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Enhanced Product Selection Modal -->
  <div
    class="modal fade show"
    [ngStyle]="{ display: showProductModal ? 'block' : 'none' }"
    tabindex="-1"
    role="dialog"
    *ngIf="showProductModal"
    (keydown.escape)="closeProductModal()"
    (keydown.enter)="
      $event.target.tagName === 'BUTTON' ? null : addProductFromModal()
    "
    style="background-color: rgba(0, 0, 0, 0.5)"
  >
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fa fa-plus-circle"></i> Add Product to Order
          </h5>
          <button
            type="button"
            class="btn btn-link text-white"
            (click)="closeProductModal()"
            title="Close (Esc)"
          >
            <i class="fa fa-times fa-lg"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- Product Image and Info -->
            <div class="col-12 col-md-4 text-center mb-3 mb-md-0">
              <!-- <img
                [src]="modalProduct.Image"
                [alt]="modalProduct.ProductName"
                class="img-fluid rounded shadow-sm"
                style="max-height: 200px; object-fit: cover"
              /> -->
              <h6 class="mt-2 text-primary">{{ modalProduct.ProductName }}</h6>
            </div>

            <!-- Product Details Form -->
            <div class="col-12 col-md-8">
              <form #modalForm="ngForm">
                <div class="row">
                  <div class="col-12 col-sm-6">
                    <div class="form-group">
                      <label for="modalQty">
                        <i class="fa fa-sort-numeric-asc"></i> Quantity *
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        id="modalQty"
                        name="modalQty"
                        [(ngModel)]="modalOrderDetail.Qty"
                        min="1"
                        max="999"
                        step="1"
                        required
                        (focus)="$event.target.select()"
                        (keydown.enter)="
                          $event.preventDefault(); focusNextInput('modalPrice')
                        "
                        placeholder="Enter quantity"
                      />
                    </div>
                  </div>

                  <div class="col-12 col-sm-6">
                    <div class="form-group">
                      <label for="modalPrice">
                        <i class="fa fa-euro"></i> Price *
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        id="modalPrice"
                        name="modalPrice"
                        [(ngModel)]="modalOrderDetail.SPrice"
                        min="0.01"
                        step="0.01"
                        required
                        (focus)="$event.target.select()"
                        (keydown.enter)="
                          $event.preventDefault(); focusNextInput('modalColor')
                        "
                        placeholder="Enter price"
                      />
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-12 col-sm-6">
                    <div class="form-group">
                      <label for="modalColor">
                        <i class="fa fa-palette"></i> Color
                      </label>
                      <ng-select
                        [items]="availableColors"
                        name="modalColor"
                        id="modalColor"
                        [(ngModel)]="modalOrderDetail.Color"
                        placeholder="Select or type color"
                        [addTag]="true"
                        [clearable]="true"
                        (keydown.enter)="
                          $event.preventDefault(); focusNextInput('modalSize')
                        "
                      >
                      </ng-select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-6">
                    <div class="form-group">
                      <label for="modalSize">
                        <i class="fa fa-expand-arrows-alt"></i> Size
                      </label>
                      <ng-select
                        [items]="availableSizes"
                        name="modalSize"
                        id="modalSize"
                        [(ngModel)]="modalOrderDetail.Size"
                        placeholder="Select or type size"
                        [addTag]="true"
                        [clearable]="true"
                        (keydown.enter)="
                          $event.preventDefault(); focusNextInput('modalNotes')
                        "
                      >
                      </ng-select>
                    </div>
                  </div>
                </div>

                <!-- Amount Display -->
                <div class="alert alert-info">
                  <div class="row align-items-center">
                    <div class="col-6">
                      <strong>Total Amount:</strong>
                    </div>
                    <div class="col-6 text-right">
                      <h5 class="mb-0 text-light">
                        €{{
                          (modalOrderDetail.Qty || 0) *
                            (modalOrderDetail.SPrice || 0) | number: '1.2-2'
                        }}
                      </h5>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-success"
            (click)="addProductFromModal()"
            [disabled]="
              !modalForm.form.valid ||
              !modalOrderDetail.Qty ||
              modalOrderDetail.Qty <= 0 ||
              !modalOrderDetail.SPrice ||
              modalOrderDetail.SPrice <= 0
            "
            title="Add to Order (Ctrl+Enter)"
          >
            <i class="fa fa-plus"></i> Add to Order
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeProductModal()"
            title="Close (Esc)"
          >
            <i class="fa fa-times"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>
  <div
    class="modal fade show"
    [ngStyle]="{ display: showPicture ? 'block' : 'none' }"
    tabindex="-1"
    role="dialog"
    *ngIf="showPicture"
    (keydown.escape)="showPicture = false"
    style="background-color: rgba(0, 0, 0, 0.5)"
  >
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fa fa-plus-circle"></i> {{ modalProduct.ProductName }}
          </h5>
          <button
            type="button"
            class="btn btn-link text-white"
            (click)="showPicture = false"
            title="Close (Esc)"
          >
            <i class="fa fa-times fa-lg"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- Product Image and Info -->
            <div class="col-12 col-md-12 text-center mb-3 mb-md-0">
              <img
                [src]="modalProduct.Image"
                [alt]="modalProduct.ProductName"
                class="img-fluid rounded"
                style="width: 100%; height: auto; object-fit: cover"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="showPicture = false"
            title="Close (Esc)"
          >
            <i class="fa fa-times"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
