<!--Enhanced Invoices List-->
<section id="ng-tables">
  <div class="row text-left mb-3">
    <div class="col-md-6">
      <div class="content-header">
        <i class="fa fa-file-invoice"></i> Invoices Management
      </div>
      <small class="text-muted">
        Manage customer invoices with detailed product information and posting
        status
      </small>
    </div>
    <div class="col-md-6 text-right">
      <div class="btn-group mr-2">
        <button
          class="btn btn-outline-primary"
          [class.active]="viewMode === 'grouped'"
          (click)="viewMode = 'grouped'"
          title="Group invoices by customer"
        >
          <i class="fa fa-users"></i> Grouped View
        </button>
        <button
          class="btn btn-outline-primary"
          [class.active]="viewMode === 'table'"
          (click)="viewMode = 'table'"
          title="Show invoices in table format"
        >
          <i class="fa fa-table"></i> Table View
        </button>
      </div>
      <button
        class="btn btn-success"
        (click)="AddNew()"
        title="Create new invoice"
      >
        <i class="fa fa-plus"></i> Add New Invoice
      </button>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
      <h6 class="mb-0"><i class="fa fa-filter"></i> Filters & Search</h6>
    </div>
    <div class="card-body">
      <ft-crud-form
        [form]="FilterForm"
        [formdata]="Filter"
        [CrudButtons]="false"
        (ItemChanged)="FilterData($event)"
      >
      </ft-crud-form>
    </div>
  </div>

  <!-- Summary Statistics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white shadow-sm">
        <div class="card-body text-center">
          <h4 class="mb-1">{{ data.length }}</h4>
          <p class="mb-0">Total Invoices</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white shadow-sm">
        <div class="card-body text-center">
          <h4 class="mb-1">{{ groupedInvoices.length }}</h4>
          <p class="mb-0">Unique Customers</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white shadow-sm">
        <div class="card-body text-center">
          <h4 class="mb-1">{{ invoiceDetails.length }}</h4>
          <p class="mb-0">Total Items</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white shadow-sm">
        <div class="card-body text-center">
          <h4 class="mb-1">
            {{ totalInvoicesAmount | currency: 'EUR':'symbol':'1.2-2' }}
          </h4>
          <p class="mb-0">Total Value</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Grouped Invoices View -->
  <div *ngIf="viewMode === 'grouped'" id="print-section">
    <div
      *ngIf="groupedInvoices.length === 0"
      class="alert alert-info text-center"
    >
      <i class="fa fa-info-circle fa-2x mb-2"></i>
      <h5>No Invoices Found</h5>
      <p>
        No invoices match your current filter criteria. Try adjusting the date
        range or search terms.
      </p>
    </div>

    <div
      *ngFor="let customerGroup of groupedInvoices; let customerIndex = index"
      class="card mb-4 shadow-sm"
    >
      <!-- Customer Header -->
      <div class="card-header bg-gradient-primary text-white">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="mb-1">
              <i class="fa fa-user"></i>
              {{ customerGroup.customer.CustomerName }}
            </h5>
            <div class="row">
              <div
                class="col-md-6"
                *ngIf="customerGroup.customer.CustomerAddress"
              >
                <small
                  ><i class="fa fa-map-marker"></i>
                  {{ customerGroup.customer.CustomerAddress }}</small
                >
              </div>
              <div
                class="col-md-6"
                *ngIf="customerGroup.customer.CustomerPhone"
              >
                <small
                  ><i class="fa fa-phone"></i>
                  {{ customerGroup.customer.CustomerPhone }}</small
                >
              </div>
            </div>
          </div>
          <div class="col-md-4 text-right">
            <h6 class="mb-1">{{ customerGroup.invoices.length }} Invoice(s)</h6>
            <h5 class="mb-0">
              {{ customerGroup.totalAmount | currency: 'EUR':'symbol':'1.2-2' }}
            </h5>
          </div>
        </div>
      </div>

      <!-- Invoices for this Customer -->
      <div class="card-body p-0">
        <div
          *ngFor="
            let invoice of customerGroup.invoices;
            let invoiceIndex = index
          "
          class="border-bottom"
          [class.bg-light]="invoiceIndex % 2 === 1"
        >
          <!-- Invoice Header -->
          <div class="p-3 bg-light border-bottom">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h6 class="mb-1">
                  <i class="fa fa-file-invoice"></i> Invoice #{{
                    invoice.InvoiceID
                  }}
                  <span
                    class="badge ml-2"
                    [class.badge-success]="
                      invoice.IsPosted === '1' || invoice.IsPosted === 1
                    "
                    [class.badge-warning]="
                      invoice.IsPosted === '0' || invoice.IsPosted === 0
                    "
                  >
                    {{
                      invoice.IsPosted === '1' || invoice.IsPosted === 1
                        ? 'Posted'
                        : 'Unposted'
                    }}
                  </span>
                </h6>
                <small class="text-muted">
                  <i class="fa fa-calendar"></i>
                  {{ invoice.Date | date: 'mediumDate' }}
                </small>
              </div>
              <div class="col-md-3 text-center">
                <h6 class="mb-0 text-success">
                  {{ invoice.Amount | currency: 'EUR':'symbol':'1.2-2' }}
                </h6>
                <small class="text-muted"
                  >{{ invoice.details?.length || 0 }} item(s)</small
                >
              </div>
              <div class="col-md-3 text-right">
                <div class="btn-group btn-group-sm">
                  <button
                    class="btn btn-outline-warning"
                    (click)="printInvoice(invoice)"
                    title="Print Invoice"
                  >
                    <i class="fa fa-print"></i>
                  </button>

                </div>
              </div>
            </div>

            <!-- Invoice Notes (if any) -->
            <div *ngIf="invoice.Notes" class="mt-2">
              <small class="text-muted">
                <i class="fa fa-sticky-note"></i> <strong>Notes:</strong>
                {{ invoice.Notes }}
              </small>
            </div>
          </div>            <!-- Invoice Items -->
            <div class="p-3">
              <div
                class="row"
                *ngIf="invoice.details && invoice.details.length > 0; else noItems"
              >
                <div class="col-12">
                  <h6 class="mb-3"><i class="fa fa-box"></i> Invoice Items</h6>
                  <div class="row">
                    <div
                      class="col-md-6 col-lg-4 mb-3"
                      *ngFor="let item of invoice.details"
                    >
                      <div class="card border product-item-card">
                        <div class="row no-gutters">
                          <div class="col-4">
                            <img
                              [src]="item.Image"
                              [alt]="item.ProductName"
                              class="card-img h-100"
                              style="
                                object-fit: cover;
                                min-height: 80px;
                                max-height: 100px;
                              "
                              (error)="
                                item.Image = UploadFolder + 'default-product.png'
                              "
                            />
                          </div>
                          <div class="col-8">
                            <div class="card-body p-2">
                              <h6
                                class="card-title text-truncate"
                                style="font-size: 0.9rem"
                                [title]="item.ProductName"
                              >
                                {{ item.ProductName }}
                              </h6>
                              <div class="row text-center">
                                <div class="col-6">
                                  <small class="text-muted">Qty</small>
                                  <div>
                                    <strong>{{ item.Qty }}</strong>
                                  </div>
                                </div>
                                <div class="col-6">
                                  <small class="text-muted">Price</small>
                                  <div>
                                    <strong>{{
                                      item.SPrice
                                        | currency: 'EUR':'symbol':'1.2-2'
                                    }}</strong>
                                  </div>
                                </div>
                              </div>
                              <div
                                class="mt-1"
                                *ngIf="item.Color && item.Color !== 'N/A'"
                              >
                                <small
                                  ><i class="fa fa-palette"></i>
                                  {{ item.Color }}</small
                                >
                              </div>
                              <div *ngIf="item.Size && item.Size !== 'N/A'">
                                <small
                                  ><i class="fa fa-expand-arrows-alt"></i>
                                  {{ item.Size }}</small
                                >
                              </div>
                              <div *ngIf="item.Notes && item.Notes !== ''">
                                <small class="text-muted"
                                  ><i class="fa fa-sticky-note"></i>
                                  {{ item.Notes }}</small
                                >
                              </div>
                              <div class="mt-1 text-center">
                                <strong class="text-success">
                                  {{
                                    item.Amount | currency: 'EUR':'symbol':'1.2-2'
                                  }}
                                </strong>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <ng-template #noItems>
                <div class="text-center text-muted py-3">
                  <i class="fa fa-box-open fa-2x mb-2"></i>
                  <p>No items found for this invoice</p>
                  <small class="text-muted">Invoice ID: {{ invoice.InvoiceID }}</small>
                </div>
              </ng-template>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Table View -->
  <div *ngIf="viewMode === 'table'" class="card shadow-sm">
    <div class="card-header bg-light">
      <h6 class="mb-0"><i class="fa fa-table"></i> Invoices Table View</h6>
    </div>
    <div class="card-body">
      <ft-dynamic-table
        #rptTable
        [Settings]="Settings"
        [Data]="data"
        [Search]="Filter.Search"
        (ClickAction)="Clicked($event)"
      ></ft-dynamic-table>
    </div>
  </div>
</section>
