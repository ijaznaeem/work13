<!-- Invoice Approval Form Component - Cloned from VB6 frmInvoiceApprovalForm -->
<div class="invoice-approval-form-container">

  <!-- Header -->
  <div class="form-header text-center mb-3">
    <h4 class="text-white bg-danger p-3 mb-0">Invoice Approval Form</h4>
  </div>

  <!-- Main Form -->
  <form [formGroup]="invoiceForm" class="mb-3">
    <div class="row">
      
      <!-- Business Selection -->
      <div class="col-md-6 mb-3">
        <label class="form-label text-primary fw-bold">Business:</label>
        <select 
          class="form-select" 
          formControlName="businessId"
          (change)="onBusinessChange()">
          <option *ngFor="let business of businesses" [value]="business.BusinessID">
            {{ business.BusinessName }}
          </option>
        </select>
      </div>

      <!-- Division Selection -->
      <div class="col-md-6 mb-3">
        <label class="form-label text-primary fw-bold">Select Division:</label>
        <select 
          class="form-select" 
          formControlName="divisionId"
          (change)="onDivisionChange()">
          <option value="">--Select Division--</option>
          <option *ngFor="let division of divisions" [value]="division.DivisionID">
            {{ division.DivisionName }}
          </option>
        </select>
      </div>
    </div>
  </form>

  <!-- Customer and Product Selection -->
  <div class="row">
    
    <!-- Left Panel - Customer Selection -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0 text-primary fw-bold">Customer:</h6>
        </div>
        <div class="card-body p-0">
          <select 
            class="form-select customer-select" 
            formControlName="customerId"
            (change)="onCustomerChange()"
            size="15">
            <option value="">--Select Customer--</option>
            <option *ngFor="let customer of customers" [value]="customer.CustomerID">
              {{ customer.CustomerName }} - {{ customer.City }}
            </option>
          </select>
        </div>
      </div>

      <!-- Customer Info Display -->
      <div class="customer-info mt-3" *ngIf="formState.selectedCustomer">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label text-primary fw-bold">Balance:</label>
                <div class="info-display">{{ formatCurrency(formState.selectedCustomer.Balance) }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label text-primary fw-bold">Limit:</label>
                <div class="info-display">{{ formatCurrency(formState.selectedCustomer.Limit) }}</div>
              </div>
              <div class="col-md-12 mt-2">
                <label class="form-label text-primary fw-bold">Address:</label>
                <div class="info-display">{{ formState.selectedCustomer.Address }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Product Entry and Display -->
    <div class="col-md-8">
      
      <!-- Product Entry Form -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Product Entry</h6>
          <button 
            type="button" 
            class="btn btn-primary btn-sm"
            [disabled]="detailForm.invalid || !formState.selectedCustomer"
            (click)="addToInvoice()">
            <i class="fas fa-plus me-1"></i>
            Add
          </button>
        </div>
        <div class="card-body">
          <form [formGroup]="detailForm">
            <div class="row">
              
              <!-- Product Selection -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Product:</label>
                <select 
                  class="form-select form-select-sm" 
                  formControlName="productId"
                  (change)="onProductChange()">
                  <option value="">--Select Product--</option>
                  <option *ngFor="let product of products" [value]="product.ProductID">
                    {{ product.ProductName }} (Stock: {{ product.Stock }})
                  </option>
                </select>
              </div>

              <!-- Quantity -->
              <div class="col-md-3 mb-3">
                <label class="form-label">Qty:</label>
                <input 
                  type="number" 
                  class="form-control form-control-sm" 
                  formControlName="qty"
                  (input)="onQuantityOrPriceChange()"
                  min="0"
                  step="1">
              </div>

              <!-- Bonus -->
              <div class="col-md-3 mb-3">
                <label class="form-label">Bonus:</label>
                <input 
                  type="number" 
                  class="form-control form-control-sm" 
                  formControlName="bonus"
                  readonly>
              </div>

              <!-- Sale Price -->
              <div class="col-md-3 mb-3">
                <label class="form-label">Sale Price:</label>
                <input 
                  type="number" 
                  class="form-control form-control-sm" 
                  formControlName="sPrice"
                  (input)="onQuantityOrPriceChange()"
                  step="0.01">
              </div>

              <!-- Purchase Price -->
              <div class="col-md-3 mb-3">
                <label class="form-label">Purchase Price:</label>
                <input 
                  type="number" 
                  class="form-control form-control-sm" 
                  formControlName="pPrice"
                  readonly>
              </div>

              <!-- Discount Ratio -->
              <div class="col-md-3 mb-3">
                <label class="form-label">Disc %:</label>
                <input 
                  type="number" 
                  class="form-control form-control-sm" 
                  formControlName="discRatio"
                  min="0"
                  max="100"
                  step="0.01">
              </div>

              <!-- Batch No -->
              <div class="col-md-3 mb-3">
                <label class="form-label">Batch No:</label>
                <input 
                  type="text" 
                  class="form-control form-control-sm" 
                  formControlName="batchNo">
              </div>

              <!-- Amount Display -->
              <div class="col-md-12">
                <div class="alert alert-info">
                  <strong>Amount: {{ formatCurrency(calculatedAmount) }}</strong>
                  <span *ngIf="selectedProduct" class="ms-3">
                    Available Stock: {{ selectedProduct.Stock }}
                  </span>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Invoice Details Grid -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Product Info:</h6>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th>S.No</th>
                  <th>Product Name</th>
                  <th>Qty</th>
                  <th>Bonus</th>
                  <th>S.Price</th>
                  <th>Amount</th>
                  <th>Discount</th>
                  <th>Net Amount</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let detail of invoiceDetails; trackBy: trackByDetailId">
                  <td>{{ detail.SNO }}</td>
                  <td>{{ detail.ProductName }}</td>
                  <td class="text-end">{{ detail.Qty }}</td>
                  <td class="text-end">{{ detail.Bonus }}</td>
                  <td class="text-end">{{ formatCurrency(detail.SPrice) }}</td>
                  <td class="text-end">{{ formatCurrency(detail.Amount) }}</td>
                  <td class="text-end">{{ formatCurrency(detail.Discount) }}</td>
                  <td class="text-end">{{ formatCurrency(detail.NetAmount) }}</td>
                  <td>
                    <button 
                      type="button" 
                      class="btn btn-danger btn-sm"
                      (click)="deleteDetail(detail)"
                      title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="invoiceDetails.length === 0">
                  <td colspan="9" class="text-center text-muted py-3">
                    No products added to invoice
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Totals Row -->
        <div class="card-footer">
          <div class="row">
            <div class="col-md-4">
              <label class="form-label text-primary fw-bold">Total Amount:</label>
              <div class="total-display">{{ formatCurrency(formState.totalAmount) }}</div>
            </div>
            <div class="col-md-4">
              <label class="form-label text-primary fw-bold">Discount:</label>
              <div class="total-display">{{ formatCurrency(formState.discountAmount) }}</div>
            </div>
            <div class="col-md-4">
              <label class="form-label text-primary fw-bold">Net Amount:</label>
              <div class="total-display text-success fw-bold">{{ formatCurrency(formState.netAmount) }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons mt-4">
    <div class="d-flex justify-content-end gap-2">
      <button 
        type="button" 
        class="btn btn-success"
        [disabled]="invoiceDetails.length === 0 || invoiceForm.invalid"
        (click)="saveInvoice()">
        <i class="fas fa-save me-1"></i>
        Save
      </button>
      <button 
        type="button" 
        class="btn btn-secondary"
        (click)="cancelInvoice()">
        <i class="fas fa-times me-1"></i>
        Cancel
      </button>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

</div>