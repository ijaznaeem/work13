<div class="recall-approvals-container">
  <!-- Header Section -->
  <div class="card border-0 box-shadow mb-3">
    <div class="card-header transparent border-0 text-muted">
      <h4 class="mb-0 text-success fw-bold">Recall Approvals</h4>
    </div>
    <div class="card-body">
      <form [formGroup]="filterForm" class="row align-items-end">
        <div class="col-md-2">
          <label for="fromDate" class="form-label text-success fw-bold">From Date:</label>
          <input
            type="date"
            id="fromDate"
            class="form-control"
            formControlName="fromDate"
            (change)="onFilterChange()"
          />
        </div>
        <div class="col-md-2">
          <label for="toDate" class="form-label text-success fw-bold">To Date:</label>
          <input
            type="date"
            id="toDate"
            class="form-control"
            formControlName="toDate"
            (change)="onFilterChange()"
          />
        </div>
        <div class="col-md-3">
          <label for="status" class="form-label text-primary fw-bold">Select Status:</label>
          <select
            id="status"
            class="form-control"
            formControlName="status"
            (change)="onFilterChange()"
          >
            <option *ngFor="let status of statusOptions" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>
        <div class="col-md-5">
          <p class="text-danger mb-0 small">
            <i class="fa fa-info-circle me-1"></i>
            Double click to add remarks
          </p>
        </div>
      </form>
      
      <!-- Action Buttons -->
      <div class="action-buttons mt-3">
        <button
          type="button"
          class="btn btn-primary btn-sm"
          (click)="AddRecall()"
        >
          <i class="fas fa-plus"></i> Add Recall
        </button>
        <button
          type="button"
          class="btn btn-success btn-sm"
          (click)="EditRecall(selectedRecall)"
          [disabled]="!selectedRecall"
        >
          <i class="fas fa-edit"></i> Edit Recall
        </button>
        <button
          type="button"
          class="btn btn-info btn-sm"
          (click)="AddComment()"
          [disabled]="!selectedRecall"
        >
          <i class="fas fa-comment"></i> Add Comment
        </button>
        <button
          type="button"
          class="btn btn-warning btn-sm"
          (click)="AddImages()"
          [disabled]="!selectedRecall"
        >
          <i class="fas fa-image"></i> Add Images
        </button>
        <button
          type="button"
          class="btn btn-danger btn-sm"
          (click)="DeleteRecall(selectedRecall)"
          [disabled]="!selectedRecall"
        >
          <i class="fas fa-trash"></i> Delete Recall
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="row">
    <!-- Left Section: Main Recall Data and Details -->
    <div class="col-md-7">
      <!-- Main Recall Data Table -->
      <div class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0 fw-bold">Recall Data</h6>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th>Date</th>
                  <th>Recall ID</th>
                  <th>Product Name</th>
                  <th>Batch No</th>
                  <th>Expiry Date</th>
                  <th>Reason</th>
                  <th>Status</th>
                  <th>Customer</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="loadingRecalls">
                  <td colspan="8" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Loading recall data...
                  </td>
                </tr>
                <tr *ngIf="!loadingRecalls && recallData.length === 0">
                  <td colspan="8" class="text-center py-3 text-muted">
                    No recall data found
                  </td>
                </tr>
                <tr
                  *ngFor="let recall of recallData"
                  [class.table-active]="isRowSelected(recall, 'recall')"
                  (click)="onRecallSelect(recall)"
                  (dblclick)="onRecallDoubleClick(recall)"
                  style="cursor: pointer;"
                >
                  <td>{{ formatDate(recall.Date) }}</td>
                  <td>{{ recall.RecallID }}</td>
                  <td>{{ recall.ProductName }}</td>
                  <td>{{ recall.BatchNo }}</td>
                  <td>{{ formatDate(recall.ExpiryDate) }}</td>
                  <td>{{ recall.Reason }}</td>
                  <td>
                    <span 
                      class="badge"
                      [ngClass]="getStatusBadgeClass(recall.Status)"
                    >
                      {{ recall.Status }}
                    </span>
                  </td>
                  <td>{{ recall.CustomerName }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Details Table -->
      <div class="card">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0 fw-bold">Recall Details</h6>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
            <table class="table table-sm mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th>Product Code</th>
                  <th>Batch No</th>
                  <th class="text-end">Quantity</th>
                  <th>QC Advice</th>
                  <th>Reason</th>
                  <th>Action Taken</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="loadingDetails">
                  <td colspan="6" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Loading details...
                  </td>
                </tr>
                <tr *ngIf="!loadingDetails && recallDetails.length === 0">
                  <td colspan="6" class="text-center py-3 text-muted">
                    Select a recall to view details
                  </td>
                </tr>
                <tr
                  *ngFor="let detail of recallDetails"
                  [class.table-active]="isRowSelected(detail, 'detail')"
                  (click)="selectedDetail = detail"
                  style="cursor: pointer;"
                >
                  <td>{{ detail.ProductCode }}</td>
                  <td>{{ detail.BatchNo }}</td>
                  <td class="text-end">{{ detail.Quantity }}</td>
                  <td 
                    (dblclick)="onDetailDoubleClick(detail, 'QCAdvice')"
                    style="cursor: text;"
                    title="Double-click to edit"
                  >
                    {{ detail.QCAdvice }}
                  </td>
                  <td 
                    (dblclick)="onDetailDoubleClick(detail, 'Reason')"
                    style="cursor: text;"
                    title="Double-click to edit"
                  >
                    {{ detail.Reason }}
                  </td>
                  <td>{{ detail.ActionTaken }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Section: Remarks and Images -->
    <div class="col-md-5">
      <!-- Remarks Section -->
      <div class="card mb-3">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0 fw-bold">Remarks</h6>
        </div>
        <div class="card-body p-2">
          <textarea
            class="form-control"
            rows="8"
            [value]="currentRemarks"
            readonly
            placeholder="Select a recall to view remarks..."
            style="resize: none; font-family: 'Courier New', monospace; font-size: 0.9rem;"
          ></textarea>
        </div>
      </div>

      <!-- Images Section -->
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h6 class="mb-0 fw-bold">
            <i class="fa fa-image me-1"></i>
            Recall Images (Double click to enlarge)
          </h6>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
            <table class="table table-sm mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th>Date</th>
                  <th>User</th>
                  <th>Description</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="loadingImages">
                  <td colspan="4" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Loading images...
                  </td>
                </tr>
                <tr *ngIf="!loadingImages && recallImages.length === 0">
                  <td colspan="4" class="text-center py-3 text-muted">
                    No images found
                  </td>
                </tr>
                <tr
                  *ngFor="let image of recallImages"
                  [class.table-active]="isRowSelected(image, 'image')"
                  (click)="selectedImage = image"
                  style="cursor: pointer;"
                >
                  <td>{{ formatDate(image.Date) }}</td>
                  <td>{{ image.UserName }}</td>
                  <td 
                    (dblclick)="viewImage(image)"
                    title="Double-click to view image"
                  >
                    {{ image.Description }}
                  </td>
                  <td class="text-center">
                    <button
                      class="btn btn-sm btn-outline-danger"
                      (click)="deleteImage(image.ImageID)"
                      title="Delete Image"
                    >
                      <i class="fa fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="card border-0 mt-3">
    <div class="card-body">
      <div class="btn-toolbar" role="toolbar">
        <div class="btn-group me-2" role="group">
          <button
            type="button"
            class="btn btn-primary"
            (click)="addApproval()"
            [disabled]="!canAdd"
          >
            <i class="fa fa-plus me-1"></i>
            Add Approval
          </button>
          
          <button
            type="button"
            class="btn btn-warning"
            (click)="editRecall()"
            [disabled]="!canEdit || !selectedRecall"
          >
            <i class="fa fa-edit me-1"></i>
            Edit
          </button>
          
          <button
            type="button"
            class="btn btn-info"
            (click)="addImage()"
            [disabled]="!canAddImages || !selectedRecall"
          >
            <i class="fa fa-image me-1"></i>
            Add Image
          </button>
        </div>
        
        <div class="btn-group me-2" role="group">
          <button
            type="button"
            class="btn btn-success"
            (click)="printDestructionNotes()"
            [disabled]="!canPrint || !selectedRecall"
          >
            <i class="fa fa-print me-1"></i>
            Print Destruction Notes
          </button>
          
          <button
            type="button"
            class="btn btn-success"
            (click)="printDispatchNotes()"
            [disabled]="!canPrint || !selectedRecall"
          >
            <i class="fa fa-print me-1"></i>
            Dispatch Notes
          </button>
        </div>
        
        <div class="btn-group" role="group">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="window.close()"
          >
            <i class="fa fa-times me-1"></i>
            Exit
          </button>
        </div>
      </div>
    </div>
  </div>
</div>