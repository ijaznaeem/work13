<!-- Budget Management Component -->
<div class="budget-management">
  <!-- Header Section -->
  <div class="header-section">
    <div class="row">
      <div class="col-md-4">
        <h3 class="page-title">Budget Management</h3>
        <p class="instruction-text text-info">
          {{ getBudgetStatsText() }} â€¢ {{ budgets.length }} budget heads
        </p>
      </div>
      <div class="col-md-8 text-right">
        <!-- Filter Controls -->
        <form [formGroup]="filterForm" class="filter-form">
          <div class="form-row">
            <!-- Budget Name Filter -->
            <div class="form-group col-md-3">
              <label for="budgetName" class="form-label">Budget Name:</label>
              <input
                type="text"
                id="budgetName"
                class="form-control form-control-sm"
                formControlName="budgetName"
                placeholder="Search budget..."
              />
            </div>

            <!-- Show Inactive -->
            <div class="form-group col-md-2">
              <label class="form-label">&nbsp;</label>
              <div class="form-check">
                <input
                  type="checkbox"
                  id="showInactive"
                  class="form-check-input"
                  formControlName="showInactive"
                />
                <label for="showInactive" class="form-check-label">
                  Show Inactive
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-group col-md-7">
              <label class="form-label">&nbsp;</label>
              <div class="btn-group w-100">
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  (click)="refreshData()"
                  title="Refresh budget data"
                >
                  <i class="fas fa-sync"></i>
                  Refresh
                </button>
                <button
                  type="button"
                  class="btn btn-success btn-sm"
                  (click)="showAddBudgetForm()"
                  title="Add new budget"
                  *ngIf="state.canAdd"
                >
                  <i class="fas fa-plus"></i>
                  Add Budget
                </button>
                <button
                  type="button"
                  class="btn btn-warning btn-sm"
                  (click)="openBudgetTransfer()"
                  title="Transfer budget between heads"
                  *ngIf="state.canAdd"
                >
                  <i class="fas fa-exchange-alt"></i>
                  Transfer Budget
                </button>
                <button
                  type="button"
                  class="btn btn-info btn-sm"
                  (click)="editBudget(state.selectedBudget!)"
                  title="Edit selected budget"
                  [disabled]="!state.selectedBudget || !state.canEdit"
                >
                  <i class="fas fa-edit"></i>
                  Edit
                </button>
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  (click)="viewBudgetDetails(state.selectedBudget!)"
                  title="View budget details and expense heads"
                  [disabled]="!state.selectedBudget"
                >
                  <i class="fas fa-eye"></i>
                  View Details
                </button>
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  (click)="showExpenseHeadsDialog()"
                  title="Manage expense heads"
                  [disabled]="!state.selectedBudget || !state.canEdit"
                >
                  <i class="fas fa-list"></i>
                  Expense Heads
                </button>
                <button
                  type="button"
                  class="btn btn-warning btn-sm"
                  (click)="exportToExcel()"
                  title="Export to Excel"
                >
                  <i class="fas fa-file-excel"></i>
                  Print
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Main Content Section -->
  <div class="content-section">
    <div class="row">
      <!-- Budget Heads Grid -->
      <div class="col-md-7">
        <div class="grid-container">
          <div class="grid-header">
            <h5>Budget Heads</h5>
            <div class="grid-tools">
              <span class="record-count">{{ budgets.length }} records</span>
            </div>
          </div>
          <div class="grid-content">
            <ft-data-grid
              #grdBudgets
              [columns]="budgetColumns"
              [data]="budgets"
              [loading]="state.loading"
              [selectionMode]="'Single'"
              [allowSorting]="true"
              [allowFiltering]="false"
              [pageSize]="20"
              [height]="500"
              [ShowSearch]="false"
              (selectionChange)="onBudgetSelected($event)"
              (rowDoubleClick)="onBudgetDoubleClick()"
              class="budget-grid"
            >
            </ft-data-grid>
          </div>
        </div>
      </div>

      <!-- Expense Heads Grid -->
      <div class="col-md-5">
        <div class="grid-container">
          <div class="grid-header">
            <h6>Expense Heads</h6>
            <div class="grid-tools">
              <span class="record-count">{{ expenseHeads.length }} entries</span>
            </div>
          </div>
          <div class="grid-content">
            <ft-data-grid
              #grdExpenseHeads
              [columns]="expenseHeadColumns"
              [data]="expenseHeads"
              [allowSorting]="true"
              [allowFiltering]="false"
              [pageSize]="10"
              [height]="500"
              [ShowSearch]="false"
              class="expense-heads-grid"
            >
            </ft-data-grid>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="state.loading" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <p class="loading-text">Loading budget data...</p>
    </div>
  </div>

  <!-- Selection Info Panel -->
  <div class="selection-info-panel" *ngIf="state.selectedBudget">
    <div class="row">
      <div class="col-md-2">
        <strong>Selected Budget:</strong> #{{ state.selectedBudget.BudgetID }}
      </div>
      <div class="col-md-3">
        <strong>Budget Name:</strong> {{ state.selectedBudget.BudgetName }}
      </div>
      <div class="col-md-2">
        <strong>Percentage:</strong> {{ formatPercentage(state.selectedBudget.Percentage) }}
      </div>
      <div class="col-md-2">
        <strong>Balance:</strong> {{ formatPercentage(state.selectedBudget.Balance) }}
      </div>
      <div class="col-md-3">
        <strong>Status:</strong> 
        <span [class]="getStatusClass(state.selectedBudget.StatusID)">
          {{ getStatusText(state.selectedBudget.StatusID) }}
        </span>
      </div>
    </div>
    <div class="row mt-2">
      <div class="col-md-4">
        <strong>Created:</strong> {{ formatDate(state.selectedBudget.CreatedDate) }}
      </div>
      <div class="col-md-4" *ngIf="state.selectedBudget.ModifiedDate">
        <strong>Modified:</strong> {{ formatDate(state.selectedBudget.ModifiedDate) }}
      </div>
      <div class="col-md-4">
        <strong>Expense Heads:</strong> {{ expenseHeads.length }}
      </div>
    </div>
  </div>

  <!-- Budget Statistics Panel -->
  <div class="statistics-panel">
    <div class="row">
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-value">{{ budgets.length }}</div>
          <div class="stat-label">Total Budgets</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-value">{{ formatPercentage(getTotalPercentageAllocated()) }}</div>
          <div class="stat-label">Total Allocated</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-value">{{ formatPercentage(getRemainingPercentage()) }}</div>
          <div class="stat-label">Remaining</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-value">{{ expenseHeads.length }}</div>
          <div class="stat-label">Expense Heads</div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Permissions Info -->
  <div class="permissions-info" *ngIf="!state.canAdd && !state.canEdit">
    <div class="alert alert-info">
      <i class="fas fa-info-circle"></i>
      You have limited permissions for budget management. Contact your administrator for full access.
    </div>
  </div>
</div>

<!-- Budget Form Modal -->
<div class="modal fade" [class.show]="showForm" [style.display]="showForm ? 'block' : 'none'" 
     tabindex="-1" role="dialog" *ngIf="showForm">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-plus text-primary mr-2" *ngIf="state.formMode === 'add'"></i>
          <i class="fas fa-edit text-primary mr-2" *ngIf="state.formMode === 'edit'"></i>
          {{ state.formMode === 'add' ? 'Add New Budget' : 'Edit Budget' }}
        </h5>
        <button type="button" class="close" (click)="hideBudgetForm()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      
      <form [formGroup]="budgetForm" (ngSubmit)="submitBudget()">
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <div class="row">
            <!-- Budget Name -->
            <div class="col-md-8 mb-3">
              <label for="budgetName" class="form-label">
                Budget Name <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                id="budgetName"
                class="form-control"
                formControlName="budgetName"
                placeholder="Enter budget name..."
                maxlength="100"
                [class.is-invalid]="hasFieldError(budgetForm, 'budgetName')"
              />
              <div class="invalid-feedback" *ngIf="hasFieldError(budgetForm, 'budgetName')">
                {{ getFieldError(budgetForm, 'budgetName') }}
              </div>
              <small class="form-text text-muted">
                {{ budgetForm.get('budgetName')?.value?.length || 0 }}/100 characters
              </small>
            </div>

            <!-- Status -->
            <div class="col-md-4 mb-3">
              <label for="statusId" class="form-label">
                Status <span class="text-danger">*</span>
              </label>
              <select
                id="statusId"
                class="form-control"
                formControlName="statusId"
                [class.is-invalid]="hasFieldError(budgetForm, 'statusId')"
              >
                <option *ngFor="let status of statusOptions" [value]="status.value">
                  {{ status.label }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="hasFieldError(budgetForm, 'statusId')">
                {{ getFieldError(budgetForm, 'statusId') }}
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Percentage -->
            <div class="col-md-6 mb-3">
              <label for="percentage" class="form-label">
                Percentage (%) <span class="text-danger">*</span>
              </label>
              <input
                type="number"
                id="percentage"
                class="form-control"
                formControlName="percentage"
                placeholder="0.00"
                min="0.01"
                max="100"
                step="0.01"
                [class.is-invalid]="hasFieldError(budgetForm, 'percentage')"
              />
              <div class="invalid-feedback" *ngIf="hasFieldError(budgetForm, 'percentage')">
                {{ getFieldError(budgetForm, 'percentage') }}
              </div>
              <small class="form-text text-muted">
                Enter percentage allocation (0.01 - 100.00)
              </small>
            </div>

            <!-- Budget Summary Info -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Budget Summary</label>
              <div class="budget-summary-card">
                <div class="summary-item">
                  <span class="summary-label">Current Total:</span>
                  <span class="summary-value">{{ formatPercentage(getTotalPercentageAllocated()) }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Remaining:</span>
                  <span class="summary-value">{{ formatPercentage(getRemainingPercentage()) }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">New Total:</span>
                  <span class="summary-value" [class.text-danger]="(getTotalPercentageAllocated() + (budgetForm.get('percentage')?.value || 0)) > 100">
                    {{ formatPercentage(getTotalPercentageAllocated() + (budgetForm.get('percentage')?.value || 0)) }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Validation Summary -->
          <div class="alert alert-warning" *ngIf="budgetForm.invalid && budgetForm.touched">
            <h6><i class="fas fa-exclamation-triangle"></i> Please correct the following errors:</h6>
            <ul class="mb-0">
              <li *ngIf="hasFieldError(budgetForm, 'budgetName')">{{ getFieldError(budgetForm, 'budgetName') }}</li>
              <li *ngIf="hasFieldError(budgetForm, 'percentage')">{{ getFieldError(budgetForm, 'percentage') }}</li>
              <li *ngIf="hasFieldError(budgetForm, 'statusId')">{{ getFieldError(budgetForm, 'statusId') }}</li>
            </ul>
          </div>

          <!-- Percentage Warning -->
          <div class="alert alert-danger" *ngIf="(getTotalPercentageAllocated() + (budgetForm.get('percentage')?.value || 0)) > 100">
            <h6><i class="fas fa-exclamation-triangle"></i> Percentage Allocation Error:</h6>
            <p class="mb-0">
              Total percentage allocation cannot exceed 100%. 
              Current total is {{ formatPercentage(getTotalPercentageAllocated()) }}, 
              and you're trying to add {{ formatPercentage(budgetForm.get('percentage')?.value || 0) }}, 
              which would total {{ formatPercentage(getTotalPercentageAllocated() + (budgetForm.get('percentage')?.value || 0)) }}.
            </p>
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="hideBudgetForm()"
            [disabled]="formSubmitting"
          >
            <i class="fas fa-times"></i>
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="budgetForm.invalid || formSubmitting || (getTotalPercentageAllocated() + (budgetForm.get('percentage')?.value || 0)) > 100"
          >
            <i class="fas fa-spinner fa-spin" *ngIf="formSubmitting"></i>
            <i class="fas fa-save" *ngIf="!formSubmitting"></i>
            {{ formSubmitting ? 'Saving...' : (state.formMode === 'add' ? 'Create Budget' : 'Update Budget') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Expense Head Form Modal -->
<div class="modal fade" [class.show]="showExpenseHeadForm" [style.display]="showExpenseHeadForm ? 'block' : 'none'" 
     tabindex="-1" role="dialog" *ngIf="showExpenseHeadForm">
  <div class="modal-dialog modal-md" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-plus text-primary mr-2"></i>
          Add Expense Head
        </h5>
        <button type="button" class="close" (click)="hideExpenseHeadForm()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      
      <form [formGroup]="expenseHeadForm" (ngSubmit)="submitExpenseHead()">
        <div class="modal-body">
          <div class="alert alert-info" *ngIf="state.selectedBudget">
            <i class="fas fa-info-circle"></i>
            Adding expense head to budget: <strong>{{ state.selectedBudget.BudgetName }}</strong>
          </div>

          <div class="row">
            <!-- Expense Head Name -->
            <div class="col-md-8 mb-3">
              <label for="expenseHead" class="form-label">
                Expense Head <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                id="expenseHead"
                class="form-control"
                formControlName="head"
                placeholder="Enter expense head name..."
                maxlength="100"
                [class.is-invalid]="hasFieldError(expenseHeadForm, 'head')"
              />
              <div class="invalid-feedback" *ngIf="hasFieldError(expenseHeadForm, 'head')">
                {{ getFieldError(expenseHeadForm, 'head') }}
              </div>
              <small class="form-text text-muted">
                {{ expenseHeadForm.get('head')?.value?.length || 0 }}/100 characters
              </small>
            </div>

            <!-- Status -->
            <div class="col-md-4 mb-3">
              <label for="expenseStatus" class="form-label">
                Status <span class="text-danger">*</span>
              </label>
              <select
                id="expenseStatus"
                class="form-control"
                formControlName="statusId"
                [class.is-invalid]="hasFieldError(expenseHeadForm, 'statusId')"
              >
                <option *ngFor="let status of statusOptions" [value]="status.value">
                  {{ status.label }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="hasFieldError(expenseHeadForm, 'statusId')">
                {{ getFieldError(expenseHeadForm, 'statusId') }}
              </div>
            </div>
          </div>

          <!-- Validation Summary -->
          <div class="alert alert-warning" *ngIf="expenseHeadForm.invalid && expenseHeadForm.touched">
            <h6><i class="fas fa-exclamation-triangle"></i> Please correct the following errors:</h6>
            <ul class="mb-0">
              <li *ngIf="hasFieldError(expenseHeadForm, 'head')">{{ getFieldError(expenseHeadForm, 'head') }}</li>
              <li *ngIf="hasFieldError(expenseHeadForm, 'statusId')">{{ getFieldError(expenseHeadForm, 'statusId') }}</li>
            </ul>
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="hideExpenseHeadForm()"
            [disabled]="formSubmitting"
          >
            <i class="fas fa-times"></i>
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="expenseHeadForm.invalid || formSubmitting"
          >
            <i class="fas fa-spinner fa-spin" *ngIf="formSubmitting"></i>
            <i class="fas fa-save" *ngIf="!formSubmitting"></i>
            {{ formSubmitting ? 'Creating...' : 'Create Expense Head' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showForm || showExpenseHeadForm" 
     (click)="cancelForm()"></div>