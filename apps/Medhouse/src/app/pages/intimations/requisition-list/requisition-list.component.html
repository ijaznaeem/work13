<!-- Requisition List Component -->
<div class="requisition-list">
  <!-- Header Section -->
  <div class="header-section">
    <div class="row">
      <div class="col-md-3">
        <h3 class="page-title">Requisitions List</h3>
        <p class="instruction-text text-info">
          {{ getStatusDescription() }} â€¢ {{ getDateRangeText() }}
        </p>
      </div>
      <div class="col-md-9 text-right">
        <!-- Filter Controls -->
        <form [formGroup]="filterForm" class="filter-form">
          <div class="form-row">
            <!-- Department Filter -->
            <div class="form-group col-md-2">
              <label for="departmentId" class="form-label">Department:</label>
              <select
                id="departmentId"
                class="form-control form-control-sm"
                formControlName="departmentId"
              >
                <option *ngFor="let dept of departments" [value]="dept.DeptID">
                  {{ dept.DeptName }}
                </option>
              </select>
            </div>

            <!-- Date Range -->
            <div class="form-group col-md-2">
              <label for="fromDate" class="form-label">From Date:</label>
              <input
                type="date"
                id="fromDate"
                class="form-control form-control-sm"
                formControlName="fromDate"
              />
            </div>
            <div class="form-group col-md-2">
              <label for="toDate" class="form-label">To Date:</label>
              <input
                type="date"
                id="toDate"
                class="form-control form-control-sm"
                formControlName="toDate"
              />
            </div>

            <!-- Status Filter -->
            <div class="form-group col-md-2">
              <label for="status" class="form-label">Status:</label>
              <select
                id="status"
                class="form-control form-control-sm"
                formControlName="status"
              >
                <option *ngFor="let status of statusOptions" [value]="status">
                  {{ status }}
                </option>
              </select>
            </div>

            <!-- Loading Mode -->
            <div class="form-group col-md-2">
              <label class="form-label">&nbsp;</label>
              <div class="form-check">
                <input
                  type="checkbox"
                  id="isLoading"
                  class="form-check-input"
                  formControlName="isLoading"
                />
                <label for="isLoading" class="form-check-label">
                  Loading Mode
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-group col-md-2">
              <label class="form-label">&nbsp;</label>
              <div class="btn-group-vertical w-100">
                <button
                  type="button"
                  class="btn btn-primary btn-sm mb-1"
                  (click)="refreshData()"
                  title="Refresh requisition data"
                >
                  <i class="fas fa-sync"></i>
                  Refresh
                </button>
                <button
                  type="button"
                  class="btn btn-success btn-sm mb-1"
                  (click)="exportToExcel()"
                  title="Export to Excel"
                >
                  <i class="fas fa-file-excel"></i>
                  Print
                </button>
                <button
                  type="button"
                  class="btn btn-info btn-sm"
                  (click)="showAddRequisitionForm()"
                  title="Add new requisition"
                  *ngIf="state.canAdd"
                >
                  <i class="fas fa-plus"></i>
                  Add
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Main Content Section -->
  <div class="content-section">
    <div class="row">
      <!-- Main Grid -->
      <div class="col-12">
        <div class="grid-container">
          <div class="grid-header">
            <h5>Requisitions List</h5>
            <div class="grid-tools">
              <span class="record-count">{{ requisitions.length }} records</span>
            </div>
          </div>
          <div class="grid-content">
            <ft-data-grid
              #grdData
              [columns]="requisitionColumns"
              [data]="requisitions"
              [loading]="state.loading"
              [selectionMode]="'Single'"
              [allowSorting]="true"
              [allowFiltering]="false"
              [pageSize]="25"
              [height]="500"
              [ShowSearch]="false"
              (selectionChange)="onRequisitionSelected($event)"
              (rowDoubleClick)="onRequisitionDoubleClick()"
              class="requisition-grid"
            >
            </ft-data-grid>
          </div>
        </div>
      </div>
    </div>

    <!-- History Grid Section -->
    <div class="row mt-3" *ngIf="state.selectedRequisition">
      <div class="col-12">
        <div class="grid-container">
          <div class="grid-header">
            <h6>Requisition History - ID: {{ state.selectedRequisition.ReqID }}</h6>
            <div class="grid-tools">
              <span class="record-count">{{ history.length }} entries</span>
            </div>
          </div>
          <div class="grid-content">
            <ft-data-grid
              #grdHistory
              [columns]="historyColumns"
              [data]="history"
              [allowSorting]="true"
              [allowFiltering]="false"
              [allowPaging]="false"
              [showToolbar]="false"
              [ShowSearch]="false"
              class="history-grid"
            >
            </ft-data-grid>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="state.loading" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <p class="loading-text">Loading requisitions...</p>
    </div>
  </div>

  <!-- Selection Info Panel -->
  <div class="selection-info-panel" *ngIf="state.selectedRequisition">
    <div class="row">
      <div class="col-md-2">
        <strong>Selected ID:</strong> #{{ state.selectedRequisition.ReqID }}
      </div>
      <div class="col-md-3">
        <strong>Initiated By:</strong> {{ state.selectedRequisition.InitiatingPerson }}
      </div>
      <div class="col-md-3">
        <strong>Department:</strong> {{ state.selectedRequisition.DeptName }}
      </div>
      <div class="col-md-2">
        <strong>Status:</strong> 
        <span [class]="getStatusClass(state.selectedRequisition.IsClosed)">
          {{ getStatusText(state.selectedRequisition.IsClosed) }}
        </span>
      </div>
      <div class="col-md-2">
        <strong>Forwarded To:</strong> {{ state.selectedRequisition.ForwardTo || 'None' }}
      </div>
    </div>
    <div class="row mt-2">
      <div class="col-md-6">
        <strong>Nature of Work:</strong> {{ state.selectedRequisition.NatureOfWork }}
      </div>
      <div class="col-md-6" *ngIf="state.selectedRequisition.Description">
        <strong>Description:</strong> {{ state.selectedRequisition.Description }}
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons" *ngIf="state.selectedRequisition">
    <div class="row">
      <div class="col-12">
        <div class="button-group">
          <!-- Edit Button -->
          <button
            type="button"
            class="btn btn-primary btn-action"
            (click)="editRequisition(state.selectedRequisition!)"
            [disabled]="!state.canEdit"
            title="Edit selected requisition"
          >
            <i class="fas fa-edit"></i>
            Edit
          </button>

          <!-- Print Button -->
          <button
            type="button"
            class="btn btn-secondary btn-action"
            (click)="exportToExcel()"
            title="Print requisition report"
          >
            <i class="fas fa-print"></i>
            Print
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Permissions Info -->
  <div class="permissions-info" *ngIf="!state.canAdd && !state.canEdit">
    <div class="alert alert-info">
      <i class="fas fa-info-circle"></i>
      You have limited permissions. Some actions may not be available based on your department role.
    </div>
  </div>
</div>

<!-- Requisition Form Modal -->
<div class="modal fade" [class.show]="showForm" [style.display]="showForm ? 'block' : 'none'" 
     tabindex="-1" role="dialog" *ngIf="showForm">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-plus text-primary mr-2"></i>
          Add New Requisition
        </h5>
        <button type="button" class="close" (click)="hideRequisitionForm()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      
      <form [formGroup]="requisitionForm" (ngSubmit)="submitRequisition()">
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <div class="row">
            <!-- Date and Time -->
            <div class="col-md-6 mb-3">
              <label for="reqDate" class="form-label">
                Date <span class="text-danger">*</span>
              </label>
              <input
                type="date"
                id="reqDate"
                class="form-control"
                formControlName="date"
                [class.is-invalid]="hasFieldError('date')"
              />
              <div class="invalid-feedback" *ngIf="hasFieldError('date')">
                {{ getFieldError('date') }}
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="reqTime" class="form-label">
                Time <span class="text-danger">*</span>
              </label>
              <input
                type="time"
                id="reqTime"
                class="form-control"
                formControlName="time"
                [class.is-invalid]="hasFieldError('time')"
              />
              <div class="invalid-feedback" *ngIf="hasFieldError('time')">
                {{ getFieldError('time') }}
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Department -->
            <div class="col-md-6 mb-3">
              <label for="reqDepartment" class="form-label">
                Department <span class="text-danger">*</span>
              </label>
              <select
                id="reqDepartment"
                class="form-control"
                formControlName="departmentId"
                [class.is-invalid]="hasFieldError('departmentId')"
              >
                <option value="">Select Department</option>
                <option *ngFor="let dept of departments" [value]="dept.DeptID" 
                        [disabled]="dept.DeptID === 0">
                  {{ dept.DeptName }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="hasFieldError('departmentId')">
                {{ getFieldError('departmentId') }}
              </div>
            </div>

            <!-- Initiated By -->
            <div class="col-md-6 mb-3">
              <label for="reqInitiatedBy" class="form-label">
                Initiated By <span class="text-danger">*</span>
              </label>
              <select
                id="reqInitiatedBy"
                class="form-control"
                formControlName="initiatedBy"
                [class.is-invalid]="hasFieldError('initiatedBy')"
              >
                <option value="">Select User</option>
                <option *ngFor="let user of users" [value]="user.UserID">
                  {{ user.UserName }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="hasFieldError('initiatedBy')">
                {{ getFieldError('initiatedBy') }}
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Forward To (Optional) -->
            <div class="col-md-12 mb-3">
              <label for="reqForwardTo" class="form-label">
                Forward To (Optional)
              </label>
              <select
                id="reqForwardTo"
                class="form-control"
                formControlName="forwardedTo"
              >
                <option value="">Select User to Forward</option>
                <option *ngFor="let user of users" [value]="user.UserID">
                  {{ user.UserName }}
                </option>
              </select>
            </div>
          </div>

          <!-- Nature of Work -->
          <div class="row">
            <div class="col-12 mb-3">
              <label for="reqNatureOfWork" class="form-label">
                Nature of Work <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                id="reqNatureOfWork"
                class="form-control"
                formControlName="natureOfWork"
                placeholder="Enter nature of work..."
                maxlength="1024"
                [class.is-invalid]="hasFieldError('natureOfWork')"
              />
              <div class="invalid-feedback" *ngIf="hasFieldError('natureOfWork')">
                {{ getFieldError('natureOfWork') }}
              </div>
              <small class="form-text text-muted">
                {{ requisitionForm.get('natureOfWork')?.value?.length || 0 }}/1024 characters
              </small>
            </div>
          </div>

          <!-- Description -->
          <div class="row">
            <div class="col-12 mb-3">
              <label for="reqDescription" class="form-label">
                Description (Optional)
              </label>
              <textarea
                id="reqDescription"
                class="form-control"
                formControlName="description"
                rows="4"
                placeholder="Enter detailed description..."
                maxlength="5000"
                [class.is-invalid]="hasFieldError('description')"
              ></textarea>
              <div class="invalid-feedback" *ngIf="hasFieldError('description')">
                {{ getFieldError('description') }}
              </div>
              <small class="form-text text-muted">
                {{ requisitionForm.get('description')?.value?.length || 0 }}/5000 characters
              </small>
            </div>
          </div>

          <!-- Validation Summary -->
          <div class="alert alert-warning" *ngIf="requisitionForm.invalid && requisitionForm.touched">
            <h6><i class="fas fa-exclamation-triangle"></i> Please correct the following errors:</h6>
            <ul class="mb-0">
              <li *ngIf="hasFieldError('date')">{{ getFieldError('date') }}</li>
              <li *ngIf="hasFieldError('time')">{{ getFieldError('time') }}</li>
              <li *ngIf="hasFieldError('departmentId')">{{ getFieldError('departmentId') }}</li>
              <li *ngIf="hasFieldError('initiatedBy')">{{ getFieldError('initiatedBy') }}</li>
              <li *ngIf="hasFieldError('natureOfWork')">{{ getFieldError('natureOfWork') }}</li>
              <li *ngIf="hasFieldError('description')">{{ getFieldError('description') }}</li>
            </ul>
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="hideRequisitionForm()"
            [disabled]="formSubmitting"
          >
            <i class="fas fa-times"></i>
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="requisitionForm.invalid || formSubmitting"
          >
            <i class="fas fa-spinner fa-spin" *ngIf="formSubmitting"></i>
            <i class="fas fa-save" *ngIf="!formSubmitting"></i>
            {{ formSubmitting ? 'Creating...' : 'Create Requisition' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Form Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showForm" (click)="hideRequisitionForm()"></div>