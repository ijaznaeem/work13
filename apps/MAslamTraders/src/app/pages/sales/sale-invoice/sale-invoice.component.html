<div widget class="card border-0 box-shadow">
  <div class="card-block pt-0 widget-body">
    <tabset #searchTab>
      <tab id="sale" heading="Sale">
        <div class="row no-gutter">
          <div class="col-md-4">
            <h5 class="mb-3">
              {{ sale.DtCr == 'CR' ? 'Sale' : 'Return' }}: {{ EditID }}
            </h5>
          </div>
          <div class="col-md-4">
            <div *ngIf="isPosted" class="text-center btn btn-danger btn-sm">
              POSTED INVOICE
            </div>
          </div>

          <div class="col-md-4">
            <div class="row no-pad">
              <div class="col-md-6">
                <div class="row no-pad">
                  <div class="col-md-6">
                    <input
                      class="form-control"
                      name="ReturnID"
                      #txtReturn
                      placeholder="Return No"
                    />
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <button
                        type="submit"
                        class="btn btn-danger form-control"
                        (click)="FindReturn(txtReturn.value)"
                        accesskey="F"
                      >
                        <i class="fa fa-search"></i>
                        Return Invoice
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="row no-pad">
                  <div class="col-md-6">
                    <input
                      class="form-control"
                      name="ino"
                      [(ngModel)]="Ino"
                      placeholder="Invoice No"
                    />
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <button
                        type="submit"
                        class="btn btn-primary form-control"
                        (click)="FindINo()"
                        accesskey="F"
                      >
                        <i class="fa fa-search"></i>
                        Find Invoice
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          class="card-block widget-body {{
            sale.DtCr == 'CR' ? 'sale-invoice' : 'return-invoice'
          }}"
        >
          <form (ngSubmit)="SaveData()" #fromPurchase="ngForm">
            <fieldset>
              <div class="row no-gutter">
                <div class="col-md-2">
                  <label for="dp1">Date:</label>
                  <div class="input-group">
                    <input
                      class="form-control"
                      placeholder="yyyy-mm-dd"
                      name="dp1"
                      [(ngModel)]="sale.Date"
                      ngbDatepicker
                      #d1="ngbDatepicker"
                      required
                      disabled
                    />
                    <div class="input-group-addon">
                      <button
                        type="button"
                        class="btn btn-warning"
                        (click)="d1.toggle()"
                      >
                        <i class="fa fa-calendar"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="col-md-1">
                  <div class="form-group">
                    <label for="invtype">Invoice Type</label>
                    <select
                      id="invtype"
                      class="form-control"
                      [(ngModel)]="sale.DtCr"
                      name="invtype"
                    >
                      <option value="CR">Sale</option>
                      <option value="DT">Return</option>
                    </select>
                  </div>
                </div>

                <div class="form-group col-md-3">
                  <label for="customer"> Customer </label>

                  <ng-select
                    #cmbCustomers
                    name="ng2select"
                    class="custom"
                    [items]="Accounts"
                    [virtualScroll]="true"
                    bindLabel="CustomerName"
                    bindValue="CustomerID"
                    placeholder="Select Customer"
                    (change)="CustomerSelected($event)"
                    required
                    [disabled]="!btnLocked"
                    [(ngModel)]="sale.CustomerID"
                    [searchFn]="customSearchFn"
                  >
                    <ng-template ng-option-tmp let-item="item">
                      <div class="row no-gutter">
                        <div class="col-md-12">
                          {{ item.CustomerName }}
                        </div>
                        <div class="col-md-9 text-italic font-small-2 mt-1">
                          <small>
                            {{ item.Address }}, {{ item.PhoneNo1 }},
                          </small>
                        </div>
                        <div class="col-md-3 text-italic font-small-2 mt-1">
                          <small>
                            {{ item.CBalance }}
                          </small>
                        </div>
                      </div>
                    </ng-template>
                  </ng-select>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label for="CustName">Refrence</label>
                    <input
                      class="form-control"
                      [(ngModel)]="sale.CustName"
                      type="text"
                      name="CustName"
                      id="CustName"
                      (focus)="$event.target.select()"
                    />
                  </div>
                </div>
                <div class="col-md-3">
                  <label for=""> Address: </label>
                  <p class="text-warning">
                    <strong>
                      {{ SelectCust?.Address }},

                      {{ SelectCust?.PhoneNo1 }}
                    </strong>
                  </p>
                </div>
                <div class="col-md-1">
                  <label for=""> Balance: </label>
                  <p class="text-warning">
                    <strong>
                      {{ sale.PrevBalance }}
                    </strong>
                  </p>
                </div>
              </div>

              <form #formqty="ngForm">
                <div class="row no-gutter">
                  <div class="col-md-3">
                    <div class="row no-gutter">
                      <div class="col-md-12">
                        <label for="customer"> Select product </label>
                        <ng-select
                          #cmbProduct
                          name="cmbProduct"
                          id="cmbProduct"
                          class="custom"
                          [items]="Stock"
                          [virtualScroll]="true"
                          bindLabel="ProductName"
                          bindValue="ProductID"
                          placeholder="Select Product"
                          (change)="ProductSelected($event)"
                          required
                          [disabled]="isPosted || !btnLocked"
                          [(ngModel)]="sdetails.ProductID"
                          (keydown.enter)="cmbStores.focus()"
                          [searchFn]="ProductSearchFn"
                        >
                          <ng-template ng-option-tmp let-item="item">
                            <div class="row no-gutter">
                              <div class="col-md-9">
                                {{ item.ProductName }}
                              </div>
                              <div
                                class="col-md-3 text-italic font-small-2 mt-1"
                              >
                                <small>
                                  {{ item.PCode }}
                                </small>
                              </div>
                            </div>
                          </ng-template>
                        </ng-select>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="Remarks">Remarks</label>
                          <input
                            type="text"
                            class="form-control"
                            id="Remarks"
                            name="Remarks"
                            [(ngModel)]="sdetails.Remarks"
                            (focus)="$event.target.select()"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="row no-gutter">
                      <div class="col-md-12">
                        <label for="stores"> Select Store </label>
                        <ng-select
                          #cmbStores
                          name="stores"
                          id="stores"
                          class="custom"
                          [items]="Stores"
                          [virtualScroll]="true"
                          bindLabel="StoreName"
                          bindValue="StoreID"
                          placeholder="Select Store"
                          (change)="StoreSelected($event)"
                          [searchFn]="ProductSearchFn"
                          required
                          [disabled]="isPosted || !btnLocked"
                          TabSelectDirective
                          [(ngModel)]="sdetails.StoreID"
                          (keydown.enter)="qty.focus()"
                        >
                          <ng-template ng-option-tmp let-item="item">
                            <div class="row no-gutter">
                              <div class="col-md-9">
                                {{ item.StoreName }}
                              </div>
                              <div
                                class="col-md-3 text-italic font-small-2 mt-1"
                              >
                                <small>
                                  {{ item.Stock }}
                                </small>
                              </div>
                            </div>
                          </ng-template>
                        </ng-select>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <label>pp</label>
                          <p>{{ sdetails.PPrice }}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-7">
                    <div class="row no-gutter">
                      <div class="col-md-2">
                        <div class="form-group">
                          <label for="qty">Qty</label>
                          <input
                            type="number"
                            class="form-control dation-field"
                            required="required"
                            id="qty"
                            name="qty"
                            [(ngModel)]="sdetails.Qty"
                            #qty
                            (focus)="qty.select()"
                          />
                        </div>
                      </div>
                      <div class="col-md-1">
                        <div class="form-group">
                          <label for="Packing">Size</label>
                          <input
                            type="number"
                            class="form-control dation-field"
                            required="required"
                            id="Packing"
                            name="Packing"
                            [(ngModel)]="sdetails.Packing"
                            disabled
                          />
                        </div>
                      </div>
                      <div class="col-md-1">
                        <div class="form-group">
                          <label for="Kgs">Units</label>
                          <input
                            type="number"
                            class="form-control dation-field"
                            required="required"
                            id="Kgs"
                            name="Kgs"
                            [(ngModel)]="sdetails.KGs"
                            #KGs
                            (focus)="KGs.select()"
                          />
                        </div>
                      </div>
                      <div class="col-md-2">
                        <div class="form-group">
                          <label for="Weight"
                            >Weight (
                            {{
                              RoundTo(
                                (sdetails.Qty +
                                  sdetails.KGs / sdetails.Packing) *
                                  selectedProduct.Weight,
                                4
                              )
                            }}
                            )</label
                          >
                          <input
                            type="number"
                            class="form-control dation-field"
                            required="required"
                            id="Weight"
                            name="Weight"
                            [(ngModel)]="sdetails.Weight"
                            [value]="
                              RoundTo(
                                (sdetails.Qty +
                                  sdetails.KGs / sdetails.Packing) *
                                  selectedProduct.Weight,
                                4
                              )
                            "
                            (change)="
                              sdetails.Qty = RoundTo(
                                sdetails.Weight / selectedProduct.Weight,
                                4
                              )
                            "
                            (focus)="$event.target.select()"
                          />
                        </div>
                      </div>
                      <div class="col-md-2">
                        <div class="form-group">
                          <label for="RPrice">Rate/Item/Feet:</label>
                          <input
                            #txtRate
                            type="number"
                            class="form-control"
                            id="SPrice"
                            name="SPrice"
                            [(ngModel)]="sdetails.SPrice"
                            min="0"
                            required
                            (keydown.enter)="AddOrder()"
                            (focus)="txtRate.select()"
                          />
                        </div>
                      </div>
                      <div class="col-md-2">
                        <div class="form-group">
                          <label for="WPrice"
                            >Rate/KG: (
                            {{
                              RoundTo(
                                GetAmount() /
                                  ((sdetails.Qty +
                                    sdetails.KGs / sdetails.Packing) *
                                    (selectedProduct.Weight == 0
                                      ? 1
                                      : selectedProduct.Weight)) /
                                  sdetails.UnitValue,
                                2
                              )
                            }}
                            )</label
                          >
                          <input
                            #WPrice
                            type="number"
                            class="form-control"
                            id="WPrice"
                            name="WPrice"
                            [(ngModel)]="sdetails.WPrice"
                            placeholder="0"
                            (change)="
                              sdetails.SPrice = RoundTo(
                                GetAmount() /
                                  (sdetails.Qty +
                                    sdetails.KGs / sdetails.Packing),
                                2
                              )
                            "
                            (focus)="$event.target.select()"
                          />
                        </div>
                      </div>

                      <div class="col-md-2">
                        <div class="form-group">
                          <label for="bonus">Amount: </label>
                          <input
                            type="number"
                            class="form-control"
                            id="pamount"
                            name="pamount"
                            [(ngModel)]="sdetails.Amount"
                            [value]="RoundTo(GetAmount(), 2)"
                            (change)="
                              sdetails.Qty = RoundTo(
                                sdetails.SPrice != 0
                                  ? sdetails.Amount /
                                      sdetails.SPrice /
                                      sdetails.Packing
                                  : sdetails.Qty,
                                2
                              )
                            "
                          />
                        </div>
                      </div>

                      <div class="col-md-2">
                        <div class="form-group">
                          <label>&nbsp; </label>
                          <button
                            #btnAdd
                            type="button"
                            class="btn btn-primary form-control"
                            [disabled]="
                              !formqty.form.valid || isPosted || !btnLocked
                            "
                            (click)="AddOrder()"
                            accesskey="a"
                          >
                            <i class="ft-plus"></i>
                            Add
                          </button>
                        </div>
                      </div>
                      <div class="col-md-2">
                        <div class="form-group">
                          <label> Stock </label>
                          <p
                            [ngClass]="{
                              'text-danger':
                                (selectedProduct.Stock *
                                  selectedProduct.Packing) /
                                  selectedProduct.Weight <=
                                0,
                              'text-success':
                                (selectedProduct.Stock *
                                  selectedProduct.Packing) /
                                  selectedProduct.Weight >
                                0
                            }"
                          >
                            <strong
                              *ngIf="selectedProduct.UnitName == 'Feet'"
                              >{{ RoundTo(selectedProduct.Stock, 0) }}</strong
                            >
                            <strong
                              *ngIf="selectedProduct.UnitName !== 'Feet'"
                              >{{
                                RoundTo(selectedProduct.TotalWeight, 0)
                              }}</strong
                            >
                          </p>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <!-- <ul>
                        <li
                          *ngIf="formqty.form.controls['qty'].errors?.required"
                        >
                          Quantity is required.
                        </li>
                        <li
                          *ngIf="
                            formqty.form.controls['Packing'].errors?.required
                          "
                        >
                          Size is required.
                        </li>
                        <li
                          *ngIf="formqty.form.controls['Kgs'].errors?.required"
                        >
                          Units are required.
                        </li>
                        <li
                          *ngIf="
                            formqty.form.controls['Weight'].errors?.required
                          "
                        >
                          Weight is required.
                        </li>
                        <li
                          *ngIf="
                            formqty.form.controls['SPrice'].errors?.required
                          "
                        >
                          Rate is required.
                        </li>
                      </ul> -->
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </fieldset>
            <div>
              <div
                #tableContainer
                class="table-responsive custom-table-height table-bordered table-condensed"
              >
                <div>
                  <ng2-smart-table
                    class="table table-hover"
                    [settings]="settings"
                    [source]="data"
                    (edit)="ConfirmEdit($event)"
                    (deleteConfirm)="onDeleteConfirm($event)"
                    (editConfirm)="onEdit($event)"
                  >
                  </ng2-smart-table>
                </div>
              </div>
              <div class="row no-gutter">
                <div class="col-md-2">
                  <div class="form-group">
                    <label>Total Weight</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <p>
                      <strong>
                        {{ RoundTo(sale.TotalWeight, 2) }}
                      </strong>
                    </p>
                  </div>
                </div>
              </div>

              <div class="row no-gutter">
                <div class="col-md-8">
                  <div class="row no-gutter">
                    <div class="col-md-3">
                      <div class="form-group">
                        <label for="notes">Notes</label>
                        <input
                          class="form-control"
                          [(ngModel)]="sale.Notes"
                          type="text"
                          name="notes"
                          id="notes"
                          (focus)="$event.target.select()"
                        />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <div class="form-group">
                          <label for="transport">Transporter</label>
                          <select
                            id="transport"
                            class="form-control"
                            name="transport"
                            [(ngModel)]="sale.TransporterID"
                            accesskey="t"
                          >
                            <option [value]="''">--Self--</option>
                            <option
                              [value]="Transporter.CustomerID"
                              *ngFor="let Transporter of Transporters"
                            >
                              {{ Transporter.CustomerName }}
                            </option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                  <fieldset [disabled]="!btnLocked">
                    <div class="row no-gutter">
                      <div class="col-md-3">
                        <div class="row no-gutter">
                          <div class="col-md-6">
                            <label for=""> {{ sale.DtCr == 'CR' ? 'Cash Received' : 'Cash Paid' }} </label>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input
                                #txtCashPaid
                                type="number"
                                class="form-control"
                                id="txtCashPaid"
                                value="0"
                                [(ngModel)]="sale.CashAmount"
                                (change)="
                                  sale.AmntRecvd =
                                    txtCashPaid.value * 1 + txtOnline.value * 1
                                "
                                name="txtCashPaid"
                                (focus)="$event.target.select()"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="row no-gutter">
                          <div class="col-md-6">
                            <label for="">Online </label>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input
                                #txtOnline
                                type="number"
                                class="form-control"
                                id="txtOnline"
                                value="0"
                                name="txtOnline"
                                [(ngModel)]="sale.OnlineCash"
                                (change)="
                                  sale.AmntRecvd =
                                    txtCashPaid.value * 1 + txtOnline.value * 1
                                "
                                (focus)="$event.target.select()"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="row no-gutter">
                          <div class="col-md-2">
                            <label for="">Banks </label>
                          </div>
                          <div class="col-md-10">
                            <div class="form-group">
                              <ng-select
                                #cmbOnlineBank
                                name="cmbOnlineBank"
                                id="cmbOnlineBank"
                                class="custom"
                                [items]="Banks"
                                bindLabel="CustomerName"
                                bindValue="CustomerID"
                                placeholder="Select Bank"
                                [(ngModel)]="sale.BankID"
                              >
                              </ng-select>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </fieldset>
                  <div class="row no-gutter">
                    <div class="col-md-3">
                      <div class="form-group">
                        <ft-navigator
                          (ClickAction)="NavigatorClicked($event)"
                          [disabled]="btnLocked"
                        >
                        </ft-navigator>
                      </div>
                    </div>
                    <div class="col-md-9">
                      <ft-buttons-bar
                        #btnBar
                        [buttons]="buttonConfigs"
                        [disabled]="btnLocked"
                      ></ft-buttons-bar>
                      &nbsp;
                      <ft-buttons-bar
                        [buttons]="btnSave"
                        [disabled]="!btnLocked"
                      ></ft-buttons-bar>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="row no-gutter">
                      <div class="col-md-8"></div>
                      <div class="col-md-2">
                        <label for="">Total Balance</label>
                      </div>
                      <div class="col-md-2">
                        <p>
                          <strong
                            >{{
                              RoundTo(
                                sale.Amount * 1 +
                                  sale.LoadingCharges * 1 +
                                  sale.DeliveryCharges * 1 +
                                  sale.Labour * 1 -
                                  sale.Discount -
                                  sale.AmntRecvd * 1 +
                                  sale.PrevBalance * 1,
                                2
                              )
                            }}
                          </strong>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <fieldset [disabled]="!btnLocked">
                    <div class="row no-gutter">
                      <div class="col-md-6">
                        <label for="gtotal">Total Amount</label>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <input
                            type="text"
                            class="form-control"
                            id="gtotal"
                            name="gtotal"
                            [(ngModel)]="sale.Amount"
                            readonly
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label for="gtotal">Delivery Charges</label>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <input
                            type="number"
                            class="form-control"
                            id="DeliveryCharges"
                            name="DeliveryCharges"
                            [(ngModel)]="sale.DeliveryCharges"
                            accesskey="l"
                            (focus)="$event.target.select()"
                          />
                        </div>
                      </div>

                      <div class="col-md-6">
                        <label for="LoadingCharges">Loading Charges</label>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <input
                            type="number"
                            class="form-control"
                            id="LoadingCharges"
                            name="LoadingCharges"
                            [(ngModel)]="sale.LoadingCharges"
                            (focus)="$event.target.select()"
                          />
                        </div>
                      </div>

                      <div class="col-md-6">
                        <label for="Labour">Cutting Labour</label>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <input
                            type="number"
                            class="form-control"
                            id="TLabour"
                            name="TLabour"
                            [(ngModel)]="sale.Labour"
                            (focus)="$event.target.select()"
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label for="Discount">Discount</label>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <input
                            type="number"
                            class="form-control"
                            id="Discount"
                            name="Discount"
                            [(ngModel)]="sale.Discount"
                            (focus)="$event.target.select()"
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label for="netTotal" *ngIf="sale.DtCr == 'CR'"
                          >Cash Received</label
                        >
                        <label for="netTotal" *ngIf="sale.DtCr == 'DT'"
                          >Payment</label
                        >
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <input
                            type="text"
                            class="form-control"
                            id="AmntRecvd"
                            name="AmntRecvd"
                            [value]="sale.AmntRecvd"
                            (focus)="$event.target.select()"
                            readonly
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label for="netTotal">Balance</label>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <input
                            type="text"
                            class="form-control"
                            id="BalanceAmount"
                            name="BalanceAmount"
                            [value]="
                              sale.Amount * 1 +
                              sale.LoadingCharges * 1 +
                              sale.DeliveryCharges * 1 +
                              sale.Labour * 1 -
                              sale.Discount -
                              sale.AmntRecvd * 1
                            "
                            disabled
                          />
                        </div>
                      </div>
                    </div>
                  </fieldset>
                </div>
              </div>
            </div>
          </form>
        </div>
      </tab>
      <tab id="search" heading="search" (selectTab)="onTabSelect()">
        <h3 class="mb-3">Search</h3>
        <div class="container">
          <ft-crud-form
            [form]="SrchForm"
            [formdata]="searchData"
            [submitbutton]="'Search...'"
            (BeforeSave)="BeforeSave($event)"
          >
          </ft-crud-form>
          <h5>Search Result</h5>
          <ft-dynamic-table
            #RptTable
            [Settings]="SrchSttings"
            [Data]="srchResult"
            (ClickAction)="Clicked($event)"
          >
          </ft-dynamic-table>
        </div>
      </tab>
    </tabset>
  </div>
</div>
<ng-template #gatepass>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Print Gate Pass</h4>
    <button
      type="button"
      class="btn-close close pull-right"
      aria-label="Close"
      (click)="modalRef?.hide()"
    >
      <span aria-hidden="true" class="visually-hidden">&times;</span>
    </button>
  </div>
  <div class="modal-body text-center">
    <p>Select Store to Print Gate Pass</p>
    <div class="container">
      <div class="custom-control mt-2 custom-radio">
        <input
          class="custom-control-input radio-inline"
          id="Store1"
          name="radio"
          type="radio"
          [value]="1"
          [(ngModel)]="GPStoreID"
        />
        <label class="custom-control-label text-primary" for="Store1">
          <b>Store 1</b>
        </label>
      </div>
      <div class="custom-control mt-2 custom-radio">
        <input
          class="custom-control-input radio-inline"
          id="Store2"
          name="radio"
          type="radio"
          [value]="2"
          [(ngModel)]="GPStoreID"
        />
        <label class="custom-control-label text-warning" for="Store2">
          <b> Store 2</b>
        </label>
      </div>
      <div class="custom-control mt-2 custom-radio">
        <input
          class="custom-control-input radio-inline"
          id="Store3"
          name="radio"
          type="radio"
          [value]="4"
          [(ngModel)]="GPStoreID"
        />
        <label class="custom-control-label text-danger" for="Store3">
          <b>Store 3</b>
        </label>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-default" (click)="confirm()">
      Yes
    </button>
    <button type="button" class="btn btn-primary" (click)="modalRef?.hide()">
      No
    </button>
  </div>
</ng-template>
